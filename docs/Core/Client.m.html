<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>IoticAgent.Core.Client API documentation</title>
    <meta name="description" content="" />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #05B;
    text-decoration: none;
    font-weight: 500;
    border-bottom: 1px dashed #CCCCCC;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #E95420;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  }

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; }

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;

      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>

  <style type="text/css">
  .codehilite .hll { background-color: #ffffcc }
.codehilite  { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>

  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">
    <li class="set"><h3><a href="#header-variables">Module variables</a></h3>
      
  <ul>
    <li class="mono"><a href="#IoticAgent.Core.Client.COMPRESSORS">COMPRESSORS</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.COMP_DEFAULT">COMP_DEFAULT</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.COMP_LZ4F">COMP_LZ4F</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.COMP_NONE">COMP_NONE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.COMP_SIZE">COMP_SIZE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.C_CREATE">C_CREATE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.C_DELETE">C_DELETE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.C_LIST">C_LIST</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.C_UPDATE">C_UPDATE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.DEBUG_ENABLED">DEBUG_ENABLED</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.E_COMPLETE">E_COMPLETE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.E_CONTROLREQ">E_CONTROLREQ</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.E_CREATED">E_CREATED</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.E_DELETED">E_DELETED</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.E_DUPLICATED">E_DUPLICATED</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.E_FAILED">E_FAILED</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.E_FAILED_CODE_LOWSEQNUM">E_FAILED_CODE_LOWSEQNUM</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.E_FEEDDATA">E_FEEDDATA</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.E_PROGRESS">E_PROGRESS</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.E_REASSIGNED">E_REASSIGNED</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.E_RECENTDATA">E_RECENTDATA</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.E_RENAMED">E_RENAMED</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.E_SUBSCRIBED">E_SUBSCRIBED</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.M_ACTION">M_ACTION</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.M_CLIENTREF">M_CLIENTREF</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.M_PAYLOAD">M_PAYLOAD</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.M_RANGE">M_RANGE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.M_RESOURCE">M_RESOURCE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.M_TYPE">M_TYPE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.PY3">PY3</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.P_CODE">P_CODE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.P_DATA">P_DATA</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.P_ENTITY_LID">P_ENTITY_LID</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.P_FEED_ID">P_FEED_ID</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.P_LID">P_LID</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.P_MESSAGE">P_MESSAGE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.P_MIME">P_MIME</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.P_POINT_ID">P_POINT_ID</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.P_POINT_TYPE">P_POINT_TYPE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.P_RESOURCE">P_RESOURCE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.P_SAMPLES">P_SAMPLES</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.P_TIME">P_TIME</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_CONTROL">R_CONTROL</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_CONTROL_META">R_CONTROL_META</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_CONTROL_TAG_META">R_CONTROL_TAG_META</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_DESCRIBE">R_DESCRIBE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_ENTITY">R_ENTITY</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_ENTITY_META">R_ENTITY_META</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_ENTITY_TAG_META">R_ENTITY_TAG_META</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_FEED">R_FEED</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_FEED_META">R_FEED_META</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_FEED_TAG_META">R_FEED_TAG_META</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_PING">R_PING</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_SEARCH">R_SEARCH</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_SUB">R_SUB</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.R_VALUE_META">R_VALUE_META</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.VALIDATION_MAX_ENCODED_LENGTH">VALIDATION_MAX_ENCODED_LENGTH</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.W_COMPRESSION">W_COMPRESSION</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.W_HASH">W_HASH</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.W_MESSAGE">W_MESSAGE</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.W_SEQ">W_SEQ</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.int_types">int_types</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.logger">logger</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.ubj_ext">ubj_ext</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.ubj_version">ubj_version</a></li>
  </ul>

    </li>


    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#IoticAgent.Core.Client.Client">Client</a></span>
        
          
  <ul>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.__init__">__init__</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.get_seqnum">get_seqnum</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.is_alive">is_alive</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.register_callback_controlreq">register_callback_controlreq</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.register_callback_created">register_callback_created</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.register_callback_debug_bad">register_callback_debug_bad</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.register_callback_debug_rcvd">register_callback_debug_rcvd</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.register_callback_debug_send">register_callback_debug_send</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.register_callback_deleted">register_callback_deleted</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.register_callback_duplicate">register_callback_duplicate</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.register_callback_feeddata">register_callback_feeddata</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.register_callback_reassigned">register_callback_reassigned</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.register_callback_recent_data">register_callback_recent_data</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.register_callback_renamed">register_callback_renamed</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.register_callback_subscription">register_callback_subscription</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_describe">request_describe</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_entity_create">request_entity_create</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_entity_delete">request_entity_delete</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_entity_list">request_entity_list</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_entity_list_all">request_entity_list_all</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_entity_meta_get">request_entity_meta_get</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_entity_meta_set">request_entity_meta_set</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_entity_meta_setpublic">request_entity_meta_setpublic</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_entity_reassign">request_entity_reassign</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_entity_rename">request_entity_rename</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_entity_tag_list">request_entity_tag_list</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_entity_tag_update">request_entity_tag_update</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_ping">request_ping</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_confirm_tell">request_point_confirm_tell</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_create">request_point_create</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_delete">request_point_delete</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_list">request_point_list</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_list_detailed">request_point_list_detailed</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_meta_get">request_point_meta_get</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_meta_set">request_point_meta_set</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_recent_config">request_point_recent_config</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_recent_info">request_point_recent_info</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_rename">request_point_rename</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_share">request_point_share</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_tag_list">request_point_tag_list</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_tag_update">request_point_tag_update</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_value_create">request_point_value_create</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_value_delete">request_point_value_delete</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_point_value_list">request_point_value_list</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_search">request_search</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_sub_ask">request_sub_ask</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_sub_create">request_sub_create</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_sub_create_local">request_sub_create_local</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_sub_delete">request_sub_delete</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_sub_list">request_sub_list</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_sub_recent">request_sub_recent</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.request_sub_tell">request_sub_tell</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.restore_event">restore_event</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.set_compression">set_compression</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.simulate_feeddata">simulate_feeddata</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.start">start</a></li>
    <li class="mono"><a href="#IoticAgent.Core.Client.Client.stop">stop</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">IoticAgent.Core.Client</span> module</h1>
  
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client" class="source">
    <div class="codehilite"><pre><span class="c1"># Copyright (c) 2016 Iotic Labs Ltd. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     https://github.com/Iotic-Labs/py-IoticAgent/blob/master/LICENSE</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="c1"># pylint: disable=too-many-lines</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span> <span class="k">as</span> <span class="n">hashfunc</span>
<span class="kn">from</span> <span class="nn">hmac</span> <span class="kn">import</span> <span class="n">new</span> <span class="k">as</span> <span class="n">hmacNew</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">a2b_hex</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">Struct</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">ubjson</span> <span class="kn">import</span> <span class="n">dumpb</span> <span class="k">as</span> <span class="n">ubjdumpb</span><span class="p">,</span> <span class="n">loadb</span> <span class="k">as</span> <span class="n">ubjloadb</span><span class="p">,</span> <span class="n">EXTENSION_ENABLED</span> <span class="k">as</span> <span class="n">ubj_ext</span><span class="p">,</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">ubj_version</span>

<span class="kn">from</span> <span class="nn">.AmqpLink</span> <span class="kn">import</span> <span class="n">AmqpLink</span>
<span class="kn">from</span> <span class="nn">.Exceptions</span> <span class="kn">import</span> <span class="n">LinkException</span><span class="p">,</span> <span class="n">LinkShutdownException</span>
<span class="kn">from</span> <span class="nn">.RequestEvent</span> <span class="kn">import</span> <span class="n">RequestEvent</span>
<span class="kn">from</span> <span class="nn">.Profiler</span> <span class="kn">import</span> <span class="n">profiled_thread</span>
<span class="kn">from</span> <span class="nn">.MessageDecoder</span> <span class="kn">import</span> <span class="n">decode_sent_msg</span><span class="p">,</span> <span class="n">decode_rcvd_msg</span>
<span class="kn">from</span> <span class="nn">.ThreadSafeDict</span> <span class="kn">import</span> <span class="n">ThreadSafeDict</span>
<span class="kn">from</span> <span class="nn">.Validation</span> <span class="kn">import</span> <span class="n">Validation</span><span class="p">,</span> <span class="n">VALIDATION_MAX_ENCODED_LENGTH</span>
<span class="kn">from</span> <span class="nn">.Compressors</span> <span class="kn">import</span> <span class="n">COMPRESSORS</span><span class="p">,</span> <span class="n">OversizeException</span>
<span class="kn">from</span> <span class="nn">.PreparedMessage</span> <span class="kn">import</span> <span class="n">PreparedMessage</span>
<span class="kn">from</span> <span class="nn">.compat</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PY3</span><span class="p">,</span> <span class="n">py_version_check</span><span class="p">,</span> <span class="n">ssl_version_check</span><span class="p">,</span> <span class="n">monotonic</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Empty</span><span class="p">,</span> <span class="n">Full</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">int_types</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">,</span> <span class="n">raise_from</span><span class="p">,</span>
    <span class="n">Lock</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">re_compile</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.ThreadPool</span> <span class="kn">import</span> <span class="n">ThreadPool</span>
<span class="kn">from</span> <span class="nn">.Mime</span> <span class="kn">import</span> <span class="n">valid_mimetype</span><span class="p">,</span> <span class="n">expand_idx_mimetype</span>
<span class="kn">from</span> <span class="nn">.RateLimiter</span> <span class="kn">import</span> <span class="n">RateLimiter</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">version_string_to_tuple</span><span class="p">,</span> <span class="n">validate_nonnegative_int</span><span class="p">,</span> <span class="n">validate_int</span>
<span class="kn">from</span> <span class="nn">.Const</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">C_CREATE</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="n">C_DELETE</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span>
    <span class="n">E_COMPLETE</span><span class="p">,</span> <span class="n">E_FAILED</span><span class="p">,</span> <span class="n">E_PROGRESS</span><span class="p">,</span> <span class="n">E_FAILED_CODE_LOWSEQNUM</span><span class="p">,</span> <span class="n">E_CREATED</span><span class="p">,</span> <span class="n">E_DUPLICATED</span><span class="p">,</span> <span class="n">E_DELETED</span><span class="p">,</span> <span class="n">E_FEEDDATA</span><span class="p">,</span>
    <span class="n">E_CONTROLREQ</span><span class="p">,</span> <span class="n">E_SUBSCRIBED</span><span class="p">,</span> <span class="n">E_RENAMED</span><span class="p">,</span> <span class="n">E_REASSIGNED</span><span class="p">,</span> <span class="n">E_RECENTDATA</span><span class="p">,</span>
    <span class="n">R_PING</span><span class="p">,</span> <span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">R_FEED</span><span class="p">,</span> <span class="n">R_CONTROL</span><span class="p">,</span> <span class="n">R_SUB</span><span class="p">,</span> <span class="n">R_ENTITY_META</span><span class="p">,</span> <span class="n">R_FEED_META</span><span class="p">,</span> <span class="n">R_CONTROL_META</span><span class="p">,</span> <span class="n">R_VALUE_META</span><span class="p">,</span>
    <span class="n">R_ENTITY_TAG_META</span><span class="p">,</span> <span class="n">R_FEED_TAG_META</span><span class="p">,</span> <span class="n">R_CONTROL_TAG_META</span><span class="p">,</span> <span class="n">R_SEARCH</span><span class="p">,</span> <span class="n">R_DESCRIBE</span><span class="p">,</span>
    <span class="n">W_SEQ</span><span class="p">,</span> <span class="n">W_HASH</span><span class="p">,</span> <span class="n">W_COMPRESSION</span><span class="p">,</span> <span class="n">W_MESSAGE</span><span class="p">,</span>
    <span class="n">M_RESOURCE</span><span class="p">,</span> <span class="n">M_TYPE</span><span class="p">,</span> <span class="n">M_CLIENTREF</span><span class="p">,</span> <span class="n">M_ACTION</span><span class="p">,</span> <span class="n">M_PAYLOAD</span><span class="p">,</span> <span class="n">M_RANGE</span><span class="p">,</span>
    <span class="n">P_CODE</span><span class="p">,</span> <span class="n">P_RESOURCE</span><span class="p">,</span> <span class="n">P_MESSAGE</span><span class="p">,</span> <span class="n">P_LID</span><span class="p">,</span> <span class="n">P_ENTITY_LID</span><span class="p">,</span> <span class="n">P_FEED_ID</span><span class="p">,</span> <span class="n">P_POINT_ID</span><span class="p">,</span> <span class="n">P_DATA</span><span class="p">,</span> <span class="n">P_MIME</span><span class="p">,</span> <span class="n">P_POINT_TYPE</span><span class="p">,</span> <span class="n">P_TIME</span><span class="p">,</span>
    <span class="n">P_SAMPLES</span><span class="p">,</span>
    <span class="n">COMP_NONE</span><span class="p">,</span> <span class="n">COMP_DEFAULT</span><span class="p">,</span> <span class="n">COMP_SIZE</span><span class="p">,</span> <span class="n">COMP_LZ4F</span><span class="p">,</span>
    <span class="n">SearchType</span><span class="p">,</span> <span class="n">SearchScope</span><span class="p">,</span> <span class="n">DescribeScope</span>
<span class="p">)</span>

<span class="n">py_version_check</span><span class="p">()</span>
<span class="n">ssl_version_check</span><span class="p">()</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">DEBUG_ENABLED</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="c1"># characters to use to generate random request id prefix</span>
<span class="n">_REQ_PREFIX_CHARS</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span>

<span class="n">_SEQ_WRAP_SIZE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">63</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># sequence numbers wrap when larger than this</span>
<span class="n">_SEQ_MAX_AHEAD</span> <span class="o">=</span> <span class="mi">1024</span>  <span class="c1"># how far head to allow sequence numbers (form container) before warning</span>

<span class="c1"># Specified separately since there isn&#39;t a direct mapping to Const.E_*</span>
<span class="n">_CB_DEBUG_KA</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c1"># amqp keepalive</span>
<span class="n">_CB_DEBUG_SEND</span> <span class="o">=</span> <span class="mi">1</span>      <span class="c1"># every published message</span>
<span class="n">_CB_DEBUG_BAD</span> <span class="o">=</span> <span class="mi">2</span>       <span class="c1"># any badly signed messages</span>
<span class="n">_CB_DEBUG_RCVD</span> <span class="o">=</span> <span class="mi">3</span>      <span class="c1"># any receIved messages (not ka, not bad)</span>
<span class="n">_CB_CREATED</span> <span class="o">=</span> <span class="mi">4</span>         <span class="c1"># a resource has been created</span>
<span class="n">_CB_DUPLICATE</span> <span class="o">=</span> <span class="mi">5</span>       <span class="c1"># a resource already exists</span>
<span class="n">_CB_RENAMED</span> <span class="o">=</span> <span class="mi">6</span>         <span class="c1"># a resource has been renamed (lid/nickname)</span>
<span class="n">_CB_DELETED</span> <span class="o">=</span> <span class="mi">7</span>         <span class="c1"># a resource has been deleted</span>
<span class="n">_CB_FEED</span> <span class="o">=</span> <span class="mi">8</span>            <span class="c1"># feedid -&gt; function (1:1)</span>
<span class="n">_CB_FEEDDATA</span> <span class="o">=</span> <span class="mi">9</span>        <span class="c1"># Catch All FEEDDATA Messages!</span>
<span class="n">_CB_CONTROL</span> <span class="o">=</span> <span class="mi">10</span>        <span class="c1"># lid -&gt; {pid -&gt; func} (1:1)</span>
<span class="n">_CB_CONTROLREQ</span> <span class="o">=</span> <span class="mi">11</span>     <span class="c1"># Catch All CONTROLREQ Messages!</span>
<span class="n">_CB_REASSIGNED</span> <span class="o">=</span> <span class="mi">12</span>     <span class="c1"># Unsolicited REASSIGNED message</span>
<span class="n">_CB_SUBSCRIPTION</span> <span class="o">=</span> <span class="mi">13</span>   <span class="c1"># Unsolicited SUBSCRIPTION count changed message</span>
<span class="n">_CB_RECENT_DATA</span> <span class="o">=</span> <span class="mi">14</span>    <span class="c1"># Requested recent data samples</span>

<span class="c1"># callback CRUD types which should be serialised</span>
<span class="n">_CB_CRUD_TYPES</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">_CB_CREATED</span><span class="p">,</span> <span class="n">_CB_DUPLICATE</span><span class="p">,</span> <span class="n">_CB_RENAMED</span><span class="p">,</span> <span class="n">_CB_DELETED</span><span class="p">,</span> <span class="n">_CB_REASSIGNED</span><span class="p">))</span>

<span class="c1"># expected content type for incoming messages</span>
<span class="n">_CONTENT_TYPE_PATTERN</span> <span class="o">=</span> <span class="n">re_compile</span><span class="p">(</span><span class="s1">r&#39;^(?</span><span class="si">%s</span><span class="s1">i)application/ubjson$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="k">if</span> <span class="n">PY3</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

<span class="c1"># unsolicited responses which never have a reference</span>
<span class="n">_RSP_NO_REF</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">E_FEEDDATA</span><span class="p">,</span> <span class="n">E_SUBSCRIBED</span><span class="p">))</span>
<span class="c1"># unsolicited responses for which reference is set by the container</span>
<span class="n">_RSP_CONTAINER_REF</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">E_CONTROLREQ</span><span class="p">,))</span>
<span class="c1"># (un)solicited responses for which a reference is optional</span>
<span class="n">_RSP_OPTIONAL_OR_NO_REF</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">E_CREATED</span><span class="p">,</span> <span class="n">E_DELETED</span><span class="p">,</span> <span class="n">E_RENAMED</span><span class="p">,</span> <span class="n">E_REASSIGNED</span><span class="p">,</span> <span class="n">E_SUBSCRIBED</span><span class="p">))</span>
<span class="c1"># responses which signify request completion</span>
<span class="n">_RSP_TYPE_FINISH</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">E_COMPLETE</span><span class="p">,</span> <span class="n">E_FAILED</span><span class="p">,</span> <span class="n">E_DUPLICATED</span><span class="p">))</span>
<span class="c1"># responses which signify successful request completion</span>
<span class="n">_RSP_TYPE_SUCCESS</span> <span class="o">=</span> <span class="n">_RSP_TYPE_FINISH</span> <span class="o">-</span> <span class="p">{</span><span class="n">E_FAILED</span><span class="p">}</span>
<span class="c1"># resonses which signify a resource now (or already) exist</span>
<span class="n">_RSP_TYPE_CREATION</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">E_CREATED</span><span class="p">,</span> <span class="n">E_DUPLICATED</span><span class="p">))</span>
<span class="c1"># responses which do not signify completion or failure and are not CRUD</span>
<span class="n">_RSP_TYPE_ONGOING</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">E_PROGRESS</span><span class="p">,</span> <span class="n">E_RECENTDATA</span><span class="p">))</span>
<span class="c1"># responses which result in callbacks for which the whole payload is passed along</span>
<span class="n">_RSP_PAYLOAD_CB_MAPPING</span> <span class="o">=</span> <span class="p">{</span><span class="n">E_CREATED</span><span class="p">:</span> <span class="n">_CB_CREATED</span><span class="p">,</span>
                           <span class="n">E_DUPLICATED</span><span class="p">:</span> <span class="n">_CB_DUPLICATE</span><span class="p">,</span>
                           <span class="n">E_RENAMED</span><span class="p">:</span> <span class="n">_CB_RENAMED</span><span class="p">,</span>
                           <span class="n">E_DELETED</span><span class="p">:</span> <span class="n">_CB_DELETED</span><span class="p">,</span>
                           <span class="n">E_REASSIGNED</span><span class="p">:</span> <span class="n">_CB_REASSIGNED</span><span class="p">,</span>
                           <span class="n">E_RECENTDATA</span><span class="p">:</span> <span class="n">_CB_RECENT_DATA</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">Client</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-instance-attributes,too-many-public-methods</span>
    <span class="sd">&quot;&quot;&quot;Iotic Labs QAPI Client</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># QAPI version targeted by Core client</span>
    <span class="n">__qapi_version</span> <span class="o">=</span> <span class="s1">&#39;1.2.0&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">vhost</span><span class="p">,</span> <span class="n">epId</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>  <span class="c1"># pylint: disable=too-many-locals</span>
                 <span class="n">sslca</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">network_retry_timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">socket_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">auto_encode_decode</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">send_queue_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                 <span class="n">throttle_conf</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        `host` amqp broker &quot;host:port&quot;</span>

<span class="sd">        `vhost` amqp broker virtual host</span>

<span class="sd">        `epId` amqp username</span>

<span class="sd">        `passwd` amqp broker password</span>

<span class="sd">        `token` ascii hex token secret</span>

<span class="sd">        `prefix` epId prefix depends on container settings</span>

<span class="sd">        `lang` language code to use for relevant (meta data) requests. If not set, the container</span>
<span class="sd">               container default will be used. See also default_lang.</span>

<span class="sd">        `sslca` path to file of broker SSL Certificate (IF NOT using Public)</span>

<span class="sd">        `network_retry_timeout` If 0 no retry/timeout else seconds.</span>

<span class="sd">        `socket_timeout` Underlying socket connection/operation timeout</span>

<span class="sd">        `auto_encode_decode` Automatically encode/decode text (utf8) and dictionaries (ubjson) when</span>
<span class="sd">                             sending/receiving point data. When sending, only applies if mime type not specified.</span>

<span class="sd">        `send_queue_size` Maximum number of unsent requets to keep in interval queue. The queue can reach</span>
<span class="sd">                          its size limit when using asynchronous requests AND either `throttle_conf` is</span>
<span class="sd">                          used or if the the client has not been connected to the container for a while</span>
<span class="sd">                          (due to network problems). Set to zero for no limit.</span>

<span class="sd">        `throttle_conf` Automatic request (outgoing) throttling, specified as comma-separate list of</span>
<span class="sd">                        REQUESTS/INTERVAL pairs. E.g. &#39;180/60,600/300&#39; would result in no more than 180</span>
<span class="sd">                        requests being sent over the last 60 seconds and no more than 600 requests over the</span>
<span class="sd">                        last 5 minutes. Used to prevent rate-limiting containers from temporarily banning</span>
<span class="sd">                        the client without requiring application code to introduce artificial delays.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ubjson version: </span><span class="si">%s</span><span class="s1"> (extension </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">ubj_version</span><span class="p">,</span> <span class="s1">&#39;enabled&#39;</span> <span class="k">if</span> <span class="n">ubj_ext</span> <span class="k">else</span> <span class="s1">&#39;disabled&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;__init__ config host=&#39;</span><span class="si">%s</span><span class="s2">&#39;, vhost=&#39;</span><span class="si">%s</span><span class="s2">&#39;, epId=&#39;</span><span class="si">%s</span><span class="s2">&#39;, passwd=&#39;</span><span class="si">%s</span><span class="s2">&#39;, token=&#39;</span><span class="si">%s</span><span class="s2">&#39;, prefix=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                     <span class="s2">&quot; , sslca=&#39;</span><span class="si">%s</span><span class="s2">&#39; network_retry_timeout=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="n">host</span><span class="p">,</span> <span class="n">vhost</span><span class="p">,</span> <span class="n">epId</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">sslca</span><span class="p">,</span> <span class="n">network_retry_timeout</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">epId</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lang_check_convert</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__local_meta</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1">#</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__token</span> <span class="o">=</span> <span class="n">a2b_hex</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="n">raise_from</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;token invalid&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
        <span class="c1"># seq (from this client)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># request id numeric component</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__reqnum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;vhost&#39;</span><span class="p">,</span> <span class="s1">&#39;passwd&#39;</span><span class="p">):</span>
            <span class="n">Validation</span><span class="o">.</span><span class="n">check_convert_string</span><span class="p">(</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
        <span class="c1"># Only applies until ping response (see start() method)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_compression</span><span class="p">(</span><span class="n">comp</span><span class="o">=</span><span class="n">COMP_NONE</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__reqpre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rnd_string</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__auto_encode_decode</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">auto_encode_decode</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span> <span class="o">=</span> <span class="n">AmqpLink</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">vhost</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dispatch_msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dispatch_ka</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">__send_ready_cb</span><span class="p">,</span> <span class="n">sslca</span><span class="o">=</span><span class="n">sslca</span><span class="p">,</span>
                                   <span class="n">socket_timeout</span><span class="o">=</span><span class="n">validate_nonnegative_int</span><span class="p">(</span><span class="n">socket_timeout</span><span class="p">,</span> <span class="s1">&#39;socket_timeout&#39;</span><span class="p">,</span>
                                                                           <span class="n">allow_zero</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="c1"># seq (from container - initial value used to surpress warning on first message from container)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cnt_seqnum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># (Core.Client has not been .start or is .stop)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__end</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="c1"># Timer used to retry sending of requests which might not have reached the broker (dummy instance set here)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="c1"># network_retry thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_timeout</span> <span class="o">=</span> <span class="n">validate_nonnegative_int</span><span class="p">(</span><span class="n">network_retry_timeout</span><span class="p">,</span> <span class="s1">&#39;network_retry_timeout&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue_size</span> <span class="o">=</span> <span class="n">validate_nonnegative_int</span><span class="p">(</span><span class="n">send_queue_size</span><span class="p">,</span> <span class="s1">&#39;send_queue_size&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_throttlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_throttlers</span><span class="p">(</span><span class="n">throttle_conf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="p">)</span>
        <span class="c1"># __requests stores all incoming messages {&#39;requestId&#39;: event}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span> <span class="o">=</span> <span class="n">ThreadSafeDict</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># Remember pending subscriptions &amp; control callbacks.  __dispatch_msg will bind them when CREATED.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span> <span class="o">=</span> <span class="n">ThreadSafeDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span> <span class="o">=</span> <span class="n">ThreadSafeDict</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># __callbacks stores (un)solicited message registered callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span> <span class="o">=</span> <span class="n">ThreadSafeDict</span><span class="p">((</span><span class="n">type_</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">type_</span> <span class="ow">in</span>
                                          <span class="p">(</span><span class="n">_CB_DEBUG_KA</span><span class="p">,</span> <span class="n">_CB_DEBUG_SEND</span><span class="p">,</span> <span class="n">_CB_DEBUG_BAD</span><span class="p">,</span> <span class="n">_CB_DEBUG_RCVD</span><span class="p">,</span> <span class="n">_CB_CREATED</span><span class="p">,</span>
                                           <span class="n">_CB_DUPLICATE</span><span class="p">,</span> <span class="n">_CB_RENAMED</span><span class="p">,</span> <span class="n">_CB_DELETED</span><span class="p">,</span> <span class="n">_CB_FEEDDATA</span><span class="p">,</span> <span class="n">_CB_CONTROLREQ</span><span class="p">,</span>
                                           <span class="n">_CB_REASSIGNED</span><span class="p">,</span> <span class="n">_CB_SUBSCRIPTION</span><span class="p">,</span> <span class="n">_CB_RECENT_DATA</span><span class="p">))</span>
        <span class="c1"># mappings of pointId -&gt; callback list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">type_</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">type_</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_CB_FEED</span><span class="p">,</span> <span class="n">_CB_CONTROL</span><span class="p">)})</span>
        <span class="c1">#</span>
        <span class="c1"># Background thread for forwarding resource CRUD related events, including completion of CRUD requests</span>
        <span class="c1"># All such callbacks happen in a single thread so ordering of potentially related events is consistent.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__crud_threadpool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">daemonic</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Callback threadpool for any callbacks not covered by CRUD thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">daemonic</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Store container params from request_ping response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__container_params</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__create_throttlers</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">end_event</span><span class="p">):</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">check_convert_string</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;throttle_conf&#39;</span><span class="p">,</span> <span class="n">no_whitespace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">min_len</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
        <span class="n">throttlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">part</span><span class="p">:</span>
                    <span class="n">iterations</span><span class="p">,</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="c1"># use end_event so that throttling does not delay shutdown</span>
                    <span class="n">throttlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RateLimiter</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">interval</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">iterations</span><span class="p">),</span> <span class="n">wait_cmd</span><span class="o">=</span><span class="n">end_event</span><span class="o">.</span><span class="n">wait</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">raise_from</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;throttle_conf invalid&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">throttlers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">epId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;EP/Agent id in use for this client&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_lang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Language in use when not explicitly specified (in meta related requests). Will be set to container default</span>
<span class="sd">        if was not set in constructor. Before calling start() this might be None.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Whether container-local metadata functionality (e.g. search) is available in this container. Before calling</span>
<span class="sd">        start() this will always be False.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__local_meta</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">container_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns container configuration parameters as a mapping. Will be empty before start() has been called&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__container_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__container_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">restore_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;restore an event based on the requestId.</span>

<span class="sd">        For example if the user app had to shutdown with pending requests.</span>
<span class="sd">        The user can rebuild the Events they were waiting for based on the requestId(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">requestId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">[</span><span class="n">requestId</span><span class="p">]</span> <span class="o">=</span> <span class="n">RequestEvent</span><span class="p">(</span><span class="n">requestId</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sync_if_crud indicates whether to serialise this callback (applies only to CRUD)&quot;&quot;&quot;</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">callable_check</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">[</span><span class="n">type_</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">register_callback_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (resource) CREATED. The</span>
<span class="sd">        callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">        the callbacks might arrive out-of-order (e.g. created point before created thing).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_CREATED</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (resource) DUPLICATE. The</span>
<span class="sd">        callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">        the callbacks might arrive out-of-order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DUPLICATE</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_renamed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (resource) RENAMED. The</span>
<span class="sd">        callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">        the callbacks might arrive out-of-order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_RENAMED</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (resource) DELETED. The</span>
<span class="sd">        callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">        the callbacks might arrive out-of-order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DELETED</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_reassigned</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (entity) REASSIGNED. The</span>
<span class="sd">        callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">        the callbacks might arrive out-of-order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_REASSIGNED</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive subscription count changes. The callback receives</span>
<span class="sd">        a single argument - a dict with r, the resource type (R_FEED or R_CONTROL), entityLid (the</span>
<span class="sd">        nickname of the thing to which the point belongs), lid (the nickname of the point) and</span>
<span class="sd">        subCount (the current subscription count). Note: Subscription count changes can occur for</span>
<span class="sd">        each new (or deleted) subscription.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_SUBSCRIPTION</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_recent_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive recent data samples. The callback receives</span>
<span class="sd">        a single argument - a dict with c, the reference to the original request, pointId, the</span>
<span class="sd">        id of the point to which the data applies, and samples, a list of dicts containing time</span>
<span class="sd">        (the timestamp of the recent data sample), mime and data. If auto_encode_decode is enabled,</span>
<span class="sd">        the data &amp; mime fields might be modified.&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_RECENT_DATA</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_debug_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function for every sent message, including on retries. The callback</span>
<span class="sd">           receives a single argument - the sent message in raw byte form.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_SEND</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_debug_rcvd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to every GOOD recieved message. The callback receives a single</span>
<span class="sd">        argument - the unwrapped message as a dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_RCVD</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_debug_bad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to every BAD received message (EG bad sign). The callback</span>
<span class="sd">        receives two arguments - the received message in raw byte form and the content type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_BAD</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_feeddata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to every FEEDDATA message! The callback receives a single</span>
<span class="sd">        dict argument, with keys of &#39;data&#39; (decoded or raw bytes), &#39;mime&#39; (None, unless payload</span>
<span class="sd">        was not decoded and has a mime type) and &#39;pid&#39; (the global id of the feed from which</span>
<span class="sd">        the data originates).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_FEEDDATA</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_controlreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to every CONTROLREQ message! The callback receives a single</span>
<span class="sd">        dict argument, with keys of &#39;data&#39; (decoded or raw bytes), &#39;mime&#39; (None, unless payload</span>
<span class="sd">        was not decoded and has a mime type), &#39;subId&#39; (the global id of the associated subscripion),</span>
<span class="sd">        &#39;entityLid&#39; (local id of the thing to which the control belongs), &#39;lid&#39; (local id of</span>
<span class="sd">        control), &#39;confirm&#39; (whether a confirmation is expected) and &#39;requestId&#39; (required for</span>
<span class="sd">        sending confirmation).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_CONTROLREQ</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">simulate_feeddata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send feed data&quot;&quot;&quot;</span>
        <span class="c1"># Separate public method since internal one does not require parameter checks</span>
        <span class="n">feedid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">feedid</span><span class="p">)</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">mime_check_convert</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">datetime_check_convert</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">to_iso8601</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__simulate_feeddata</span><span class="p">(</span><span class="n">feedid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">time</span><span class="p">)</span>

    <span class="c1"># Used by both simulate_feeddata() and internally to propagate feed data</span>
    <span class="k">def</span> <span class="nf">__simulate_feeddata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
               <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">feedid</span><span class="p">,</span>
               <span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">,</span>
               <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">}</span>

        <span class="c1"># general catch-all</span>
        <span class="n">have_general</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_FEEDDATA</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="c1"># just for this feed</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">[</span><span class="n">_CB_FEED</span><span class="p">][</span><span class="n">feedid</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">have_general</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Received Feed Data for Point GUID &#39;</span><span class="si">%s</span><span class="s2">&#39; but no callback registered.&quot;</span><span class="p">,</span> <span class="n">feedid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

    <span class="c1"># Unlike simulate_feeddata this attempts to decode!</span>
    <span class="k">def</span> <span class="nf">__handle_controlreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">requestId</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">mime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bytes_to_share_data</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">arg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;requestId&#39;</span><span class="p">:</span> <span class="n">requestId</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                    <span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">})</span>

        <span class="c1"># general catch-all</span>
        <span class="n">have_general</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_CONTROLREQ</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="c1"># just for this control</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">[</span><span class="n">_CB_CONTROL</span><span class="p">][</span><span class="n">payload</span><span class="p">[</span><span class="n">P_ENTITY_LID</span><span class="p">]][</span><span class="n">payload</span><span class="p">[</span><span class="n">P_LID</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">have_general</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Received Control Request for </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2"> but no callback registered.&quot;</span><span class="p">,</span>
                               <span class="n">payload</span><span class="p">[</span><span class="n">P_ENTITY_LID</span><span class="p">],</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_LID</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa (complexity)</span>
        <span class="sd">&quot;&quot;&quot;Start the send &amp; recv Threads.</span>
<span class="sd">        Start can be delayed to EG restore requestIds before attaching to the QAPI</span>
<span class="sd">        Note: This function waits for/blocks until amqplink connect(s) and the current</span>
<span class="sd">              sequence number has been obtained from the container (within 5 seconds)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__network_retry</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;network&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="n">raise_from</span><span class="p">(</span><span class="n">LinkException</span><span class="p">(</span><span class="s2">&quot;Core.AmqpLink: Failed to connect&quot;</span><span class="p">),</span> <span class="n">exc</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Unhandled startup error&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

            <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_ping</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">LinkException</span><span class="p">(</span><span class="s2">&quot;No container response to ping within 5s&quot;</span><span class="p">)</span>
            <span class="c1"># (for req.payload) pylint: disable=unsubscriptable-object</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">req</span><span class="o">.</span><span class="n">payload</span><span class="p">[</span><span class="n">P_MESSAGE</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unexpected ping failure: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">info</span><span class="p">)</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">payload</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__qapi_version_check</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__container_params</span> <span class="o">=</span> <span class="n">payload</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_compression</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">raise_from</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Container compression method (</span><span class="si">%d</span><span class="s1">) unsupported&#39;</span> <span class="o">%</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">]),</span> <span class="n">ex</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__local_meta</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;local_meta&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__crud_threadpool</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__qapi_version_check</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">qapi_version</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unable to perform version check - version not included&#39;</span><span class="p">)</span>

        <span class="n">qapi_str</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">qapi_version</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">version_string_to_tuple</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__qapi_version</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qapi_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;QAPI major version difference: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> expected)&#39;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">qapi_str</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__qapi_version</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">qapi_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">expected</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;QAPI minor version older: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> known)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qapi_str</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__qapi_version</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">qapi_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">expected</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;QAPI minor version difference: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> known)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qapi_str</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__qapi_version</span><span class="p">),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">qapi_version</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">expected</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;QAPI patch level change: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> known)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qapi_str</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__qapi_version</span><span class="p">),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;QAPI version: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">qapi_str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the Client, disconnect from queue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_timer</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__crud_threadpool</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="c1"># Clear out remaining pending requests</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
            <span class="n">shutdown</span> <span class="o">=</span> <span class="n">LinkShutdownException</span><span class="p">(</span><span class="s1">&#39;Client stopped&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">req</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">shutdown</span>
                <span class="n">req</span><span class="o">.</span><span class="n">_set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__clear_references</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">remove_request</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> unfinished request(s) discarded&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__container_params</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set_compression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="n">COMP_DEFAULT</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">COMP_SIZE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override compression method (defined by container) and threshold&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">comp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">COMPRESSORS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comp</span> <span class="o">==</span> <span class="n">COMP_LZ4F</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;lz4f compression not available, required lz4framed&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid compression method&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;size must be non-negative integer&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__comp_default</span> <span class="o">=</span> <span class="n">comp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__comp_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__comp_default</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__comp_size</span>

    <span class="k">def</span> <span class="nf">get_seqnum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__valid_seqnum</span><span class="p">(</span><span class="n">seqnum</span><span class="p">,</span> <span class="n">prev_seqnum</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">seqnum</span> <span class="o">&lt;</span> <span class="n">_SEQ_WRAP_SIZE</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">seqnum</span> <span class="o">-</span> <span class="n">prev_seqnum</span><span class="p">)</span> <span class="o">%</span> <span class="n">_SEQ_WRAP_SIZE</span> <span class="o">&lt;=</span> <span class="n">_SEQ_MAX_AHEAD</span>

    <span class="c1">#</span>
    <span class="c1"># Client request functions</span>
    <span class="c1">#</span>
    <span class="c1"># Note about naming of function args</span>
    <span class="c1">#  requestId = string unique</span>
    <span class="c1">#  lid = local name to user</span>
    <span class="c1">#  pid = local name to user</span>
    <span class="c1">#  foc = R_FEED or R_CONTROL used on point functions which accept both</span>
    <span class="c1">#  slid = subscribing lid (local only)</span>
    <span class="c1">#  gpid = guid of point EG to subscribe to</span>
    <span class="c1">#  sub_id = subscription ID used for ask/tell etc</span>
    <span class="c1">#  data = STRING of the data to share,ask,tell etc</span>
    <span class="c1">#  limit = int EG 50 (num rows)</span>
    <span class="c1">#  offset = int EG 0 (starting position)</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">requestId</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">is_crud</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;_request amqp queue publish helper</span>

<span class="sd">        return: RequestEvent object or None for failed to publish</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span>
        <span class="k">if</span> <span class="n">end</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Request made whilst client not running&#39;</span><span class="p">)</span>

        <span class="n">rng</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">Validation</span><span class="o">.</span><span class="n">limit_offset_check</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">requestId</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">requestId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__new_request_id</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">requestId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;requestId </span><span class="si">%s</span><span class="s1"> already in use&#39;</span> <span class="o">%</span> <span class="n">requestId</span><span class="p">)</span>
            <span class="n">inner_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_innermsg</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">requestId</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">[</span><span class="n">requestId</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">RequestEvent</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span> <span class="n">inner_msg</span><span class="p">,</span> <span class="n">is_crud</span><span class="o">=</span><span class="n">is_crud</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__retry_enqueue</span><span class="p">(</span><span class="n">PreparedMessage</span><span class="p">(</span><span class="n">inner_msg</span><span class="p">,</span> <span class="n">requestId</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">LinkShutdownException</span><span class="p">(</span><span class="s1">&#39;Client stopped&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="c1"># don&#39;t block shutdown on full send queue. returns True if did enqueue, False if shutting down</span>
    <span class="k">def</span> <span class="nf">__retry_enqueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">end_wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">wait</span>
        <span class="n">queue_put_nowait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span><span class="o">.</span><span class="n">put_nowait</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># don&#39;t block shutdown on full send queue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">queue_put_nowait</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Full</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">end_wait</span><span class="p">(</span><span class="o">.</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__send_ready_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_send_failure_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback from AmqpLink on send transport readiness. (Only ever comes from a single thread.)&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Readiness notification (last failed=</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">last_send_failure_time</span><span class="p">)</span>
        <span class="c1"># It is possible for multiple timers to be scheduled (if multiple transport failures happen in a fairly short</span>
        <span class="c1"># amount of time. See logic for __send_retry_requests</span>
        <span class="k">if</span> <span class="n">last_send_failure_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_timer</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="c1"># allow 10s for responses to come in before attempting to resend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">last_send_failure_time</span><span class="p">,))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__send_retry_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_send_failure_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called via Timer from __send_ready to resend requests which might not have been sent due to transport</span>
<span class="sd">           failure. This can happen since the current transport implementation does not received acknowledgements</span>
<span class="sd">           for sent messages.&quot;&quot;&quot;</span>
        <span class="c1"># make sure multiple failures having set multiple times do not run concurrently</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_lock</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="c1"># produce list instead of generator as requests mapping can change during subsequent loop</span>
                <span class="n">retry_reqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">req</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                              <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">_sent_without_response</span><span class="p">(</span><span class="n">last_send_failure_time</span><span class="p">)]</span>

            <span class="n">retry_req_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># don&#39;t continue if another network failure has occured (which will trigger this function again)</span>
            <span class="k">while</span> <span class="n">retry_reqs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span><span class="o">.</span><span class="n">last_send_exc_time</span> <span class="o">&lt;=</span> <span class="n">last_send_failure_time</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">retry_reqs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="c1"># lock individuallly so incoming request handling does not &#39;pause&#39; for too long</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                    <span class="c1"># might have received a response (or finished since)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">id_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span> <span class="ow">and</span> <span class="n">req</span><span class="o">.</span><span class="n">_sent_without_response</span><span class="p">(</span><span class="n">last_send_failure_time</span><span class="p">)):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not resending request </span><span class="si">%s</span><span class="s1"> (finished or has received response)&#39;</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">id_</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Resending request </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">id_</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__retry_enqueue</span><span class="p">(</span><span class="n">PreparedMessage</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">_inner_msg_out</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">id_</span><span class="p">)):</span>
                    <span class="c1"># client shutdown</span>
                    <span class="k">break</span>
                <span class="n">retry_req_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">retry_req_count</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Resending of </span><span class="si">%d</span><span class="s1"> request(s) complete (before </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">retry_req_count</span><span class="p">,</span> <span class="n">last_send_failure_time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_ping&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_PING</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">epId</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;request entity create: lid = local name to user</span>
<span class="sd">        If epId=None (default), the current agent/EP is chosen</span>
<span class="sd">        If epId=False, no agent is assigned</span>
<span class="sd">        If epId=guid, said agent is chosen</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">epId</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">epId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span>
        <span class="k">elif</span> <span class="n">epId</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">epId</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epId</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">epId</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_create lid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;epId&#39;</span><span class="p">:</span> <span class="n">epId</span><span class="p">,</span> <span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">lid</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">newlid</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">newlid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">newlid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_rename lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; -&gt; newlid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">newlid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">newlid</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_reassign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">nepId</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;request entity to be reassigned to given ep/agent</span>
<span class="sd">        If nepId=None (default), the current agent/EP is chosen</span>
<span class="sd">        If nepId=False, no agent is assigned</span>
<span class="sd">        If nepId=guid, said agent is chosen</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nepId</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nepId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span>
        <span class="k">elif</span> <span class="n">nepId</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">nepId</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nepId</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">nepId</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_reassign lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; -&gt; nepId=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">nepId</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="s1">&#39;reassign&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;epId&#39;</span><span class="p">:</span> <span class="n">nepId</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_delete lid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_DELETE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_list&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__epId</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_list_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_list_all&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_meta_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">metafmt_check_convert</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_meta_get lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; fmt=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_META</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">request_entity_meta_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">metafmt_check_convert</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_meta_set lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; fmt=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_META</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="n">meta</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">fmt</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_entity_meta_setpublic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_meta_setpublic lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; public=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">public</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_META</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="s1">&#39;setPublic&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;public&#39;</span><span class="p">:</span> <span class="n">public</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_entity_tag_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">tags_check_convert</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="n">delete</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">bool_check_convert</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_tag_update lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; tags=</span><span class="si">%s</span><span class="s2"> delete=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_TAG_META</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="n">delete</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_entity_tag_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_tag_list lid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_TAG_META</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">control_cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">save_recent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;request point create: feed or control, lid and pid point lid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">save_recent</span> <span class="o">=</span> <span class="n">validate_int</span><span class="p">(</span><span class="n">save_recent</span><span class="p">,</span> <span class="s1">&#39;save_recent&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_create foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; save_recent=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">save_recent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">foc</span> <span class="o">==</span> <span class="n">R_CONTROL</span><span class="p">:</span>
            <span class="n">Validation</span><span class="o">.</span><span class="n">callable_check</span><span class="p">(</span><span class="n">control_cb</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save_recent</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ignoring non-zero save_recent value for control&#39;</span><span class="p">)</span>
            <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">pid</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_cb</span>
            <span class="k">return</span> <span class="n">evt</span>
        <span class="k">elif</span> <span class="n">control_cb</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;callback specified for Feed&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;saveRecent&#39;</span><span class="p">:</span> <span class="n">save_recent</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">newpid</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">newpid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">newpid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_rename foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; -&gt; newpid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">newpid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">newpid</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_confirm_tell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">requestId</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">bool_check_convert</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="n">success</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_confirm_tell foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; success=</span><span class="si">%s</span><span class="s2"> requestId=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span>
                     <span class="n">success</span><span class="p">,</span> <span class="n">requestId</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;confirm&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">success</span><span class="p">},</span> <span class="n">requestId</span><span class="o">=</span><span class="n">requestId</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_delete foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_DELETE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_list foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_list_detailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_list_detailed foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">request_point_recent_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_recent_info foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;recent&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">request_point_recent_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">max_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">max_samples</span> <span class="o">=</span> <span class="n">validate_int</span><span class="p">(</span><span class="n">max_samples</span><span class="p">,</span> <span class="s1">&#39;max_samples&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_recent_config foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;recent&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;maxSamples&#39;</span><span class="p">:</span> <span class="n">max_samples</span><span class="p">})</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__res_to_meta</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="n">R_FEED</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">R_FEED_META</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="o">==</span> <span class="n">R_CONTROL</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">R_CONTROL_META</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">request_point_meta_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">metafmt_check_convert</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="n">foc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__res_to_meta</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_meta_get foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; fmt=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">request_point_meta_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">metafmt_check_convert</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="n">foc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__res_to_meta</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_meta_set foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; fmt=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="n">meta</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">fmt</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_point_value_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">vtype</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">value_type_check_convert</span><span class="p">(</span><span class="n">vtype</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">label_check_convert</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lang_check_convert</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span><span class="p">)</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">comment_check_convert</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_value_create foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; label=</span><span class="si">%s</span><span class="s2"> vtype=</span><span class="si">%s</span><span class="s2"> lang=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span>
                     <span class="n">label</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_VALUE_META</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">),</span>
                             <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">vtype</span><span class="p">,</span> <span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_point_value_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">label_check_convert</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_value_delete foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; label=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_VALUE_META</span><span class="p">,</span> <span class="n">C_DELETE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">)</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">request_point_value_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_value_list foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_VALUE_META</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">),</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__point_type_to_tag_type</span><span class="p">(</span><span class="n">foc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">foc</span> <span class="o">==</span> <span class="n">R_FEED</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">R_FEED_TAG_META</span>
        <span class="k">elif</span> <span class="n">foc</span> <span class="o">==</span> <span class="n">R_CONTROL</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">R_CONTROL_TAG_META</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown point type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">foc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_tag_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">tags_check_convert</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="n">delete</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">bool_check_convert</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_tag_update foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; tags=</span><span class="si">%s</span><span class="s2"> delete=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__point_type_to_tag_type</span><span class="p">(</span><span class="n">foc</span><span class="p">),</span>
                             <span class="n">C_UPDATE</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span>
                             <span class="p">{</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="n">delete</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_point_tag_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_tag_list foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__point_type_to_tag_type</span><span class="p">(</span><span class="n">foc</span><span class="p">),</span>
                             <span class="n">C_LIST</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span>
                             <span class="bp">None</span><span class="p">,</span>
                             <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_sub_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">gpid</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">gpid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">foc</span> <span class="o">==</span> <span class="n">R_FEED</span><span class="p">:</span>
            <span class="n">Validation</span><span class="o">.</span><span class="n">callable_check</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Subscription for control cannot have callback&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_create foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; gpid=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">gpid</span><span class="p">)</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">gpid</span><span class="p">),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="k">return</span> <span class="n">evt</span>

    <span class="k">def</span> <span class="nf">request_sub_create_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">slid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">slid</span><span class="p">)</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">foc</span> <span class="o">==</span> <span class="n">R_FEED</span><span class="p">:</span>
            <span class="n">Validation</span><span class="o">.</span><span class="n">callable_check</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Subscription for control cannot have callback&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_create_local slid=</span><span class="si">%s</span><span class="s2"> foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">slid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">slid</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="k">return</span> <span class="n">evt</span>

    <span class="k">def</span> <span class="nf">__point_data_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="sd">&quot;&quot;&quot;Returns tuple of mime type &amp; data. Auto encodes unicode strings (to utf8) and</span>
<span class="sd">           dictionaries (to ubjson) depending on client setting.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mime</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__auto_encode_decode</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">data</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="c1"># check top level dictionary keys</span>
                    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">):</span>
                        <span class="k">return</span> <span class="s1">&#39;idx/1&#39;</span><span class="p">,</span> <span class="n">ubjdumpb</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># application/ubjson</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;At least one key in dict not real (unicode) string&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">):</span>
                    <span class="k">return</span> <span class="s1">&#39;idx/2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>  <span class="c1"># text/plain; charset=utf8</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot auto-encode data of type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No mime type specified and not bytes object (auto-encode disabled)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">valid_mimetype</span><span class="p">(</span><span class="n">mime</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">mime</span><span class="p">,</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mime specified but data not bytes object&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid mime type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mime</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__bytes_to_share_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempt to auto-decode data&quot;&quot;&quot;</span>
        <span class="n">rbytes</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_DATA</span><span class="p">]</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_MIME</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__auto_encode_decode</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rbytes</span><span class="p">,</span> <span class="n">mime</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">expand_idx_mimetype</span><span class="p">(</span><span class="n">mime</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mime</span> <span class="o">==</span> <span class="s1">&#39;application/ubjson&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ubjloadb</span><span class="p">(</span><span class="n">rbytes</span><span class="p">),</span> <span class="bp">None</span>
            <span class="k">elif</span> <span class="n">mime</span> <span class="o">==</span> <span class="s1">&#39;text/plain; charset=utf8&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rbytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rbytes</span><span class="p">,</span> <span class="n">mime</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;auto-decode failed, returning bytes&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">DEBUG_ENABLED</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rbytes</span><span class="p">,</span> <span class="n">mime</span>

    <span class="k">def</span> <span class="nf">request_point_share</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_share lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">mime_check_convert</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">datetime_check_convert</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">mime</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__point_data_to_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_FEED</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;share&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_sub_ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_ask sub_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">)</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">sub_id</span><span class="p">)</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">mime_check_convert</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">mime</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__point_data_to_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_id</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_sub_tell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_tell sub_id=</span><span class="si">%s</span><span class="s2"> timeout=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">sub_id</span><span class="p">)</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">mime_check_convert</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">mime</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__point_data_to_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_id</span><span class="p">,</span> <span class="s1">&#39;tell&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">timeout</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_sub_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_delete sub_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_DELETE</span><span class="p">,</span> <span class="p">(</span><span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">sub_id</span><span class="p">),),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_sub_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_list lid=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_sub_recent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_recent sub_id=</span><span class="si">%s</span><span class="s2">, count=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">sub_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_id</span><span class="p">,</span> <span class="s1">&#39;recent&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="n">SearchType</span><span class="o">.</span><span class="n">FULL</span><span class="p">,</span>
                       <span class="n">local</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">SearchScope</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_search text=</span><span class="si">%s</span><span class="s2"> lang=</span><span class="si">%s</span><span class="s2"> location=</span><span class="si">%s</span><span class="s2"> unit=</span><span class="si">%s</span><span class="s2"> limit=</span><span class="si">%s</span><span class="s2"> offset=</span><span class="si">%s</span><span class="s2"> type_=</span><span class="si">%s</span><span class="s2"> scope=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="n">text</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">local</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Use scope instead of local parameter&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="c1"># Preserve old behaviour until local parameter removed</span>
            <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="n">SearchScope</span><span class="o">.</span><span class="n">LOCAL</span>
        <span class="k">elif</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SearchScope</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;scope not one of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">SearchScope</span><span class="p">))</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">search_type_check_convert</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SEARCH</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">type_</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">scope</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                             <span class="n">Validation</span><span class="o">.</span><span class="n">search_check_convert</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span>
                                                             <span class="n">default_lang</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span><span class="p">),</span>
                             <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">DescribeScope</span><span class="o">.</span><span class="n">AUTO</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_describe guid=</span><span class="si">%s</span><span class="s2"> lang=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">local</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Use scope instead of local parameter&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="c1"># Preserve old behaviour until local parameter removed</span>
            <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="n">DescribeScope</span><span class="o">.</span><span class="n">LOCAL</span>
        <span class="k">elif</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DescribeScope</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;scope not one of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">DescribeScope</span><span class="p">))</span>
        <span class="n">guid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">guid</span><span class="p">)</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lang_check_convert</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_DESCRIBE</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">guid</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">scope</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__rnd_string</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_REQ_PREFIX_CHARS</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__new_request_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;requestId follows form &quot;pre num&quot; where pre is some random ascii prefix EG 6 chars long</span>
<span class="sd">        and num is an ever increasing number (self.__reqnum). MUST be called within self.__requests lock</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># Since seqnum wraps on 2^64 at most, this should always fit into 32 chars (QAPI request id limit)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum_lock</span><span class="p">:</span>
                <span class="n">requestId</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reqpre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reqnum</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__reqnum</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">requestId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># in the unlikely event of a collision update prefix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__reqpre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rnd_string</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">requestId</span>

    <span class="c1"># used by __make_hash</span>
    <span class="n">__byte_packer</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;&gt;Q&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__make_hash</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">innermsg</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">seqnum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the hash for this innermsg, token, seqnum</span>
<span class="sd">        return digest bytes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hobj</span> <span class="o">=</span> <span class="n">hmacNew</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">digestmod</span><span class="o">=</span><span class="n">hashfunc</span><span class="p">)</span>
        <span class="n">hobj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">innermsg</span><span class="p">)</span>
        <span class="n">hobj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__byte_packer</span><span class="p">(</span><span class="n">seqnum</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hobj</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__check_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return true/false if hash is good</span>
<span class="sd">        message = dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">[</span><span class="n">W_HASH</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_hash</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="n">W_MESSAGE</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__token</span><span class="p">,</span> <span class="n">message</span><span class="p">[</span><span class="n">W_SEQ</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__make_innermsg</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return innermsg chunk (dict)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;action must be None/tuple/list&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">{</span><span class="n">M_RESOURCE</span><span class="p">:</span> <span class="n">resource</span><span class="p">,</span>
             <span class="n">M_TYPE</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">rtype</span><span class="p">),</span>
             <span class="n">M_CLIENTREF</span><span class="p">:</span> <span class="n">ref</span><span class="p">,</span>
             <span class="c1"># Ensure action path consists only of strings</span>
             <span class="n">M_ACTION</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">u</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">action</span><span class="p">)</span> <span class="k">if</span> <span class="n">action</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
             <span class="n">M_PAYLOAD</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1"># Note: fmtted like &quot;0/15&quot; where 0 = offset, 15 = limit</span>
            <span class="n">p</span><span class="p">[</span><span class="n">M_RANGE</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">__request_except</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestId</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">set_and_forget</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set exception (if not None) for the given request and (optionally) remove from internal cache &amp; setting its</span>
<span class="sd">           event&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">set_and_forget</span><span class="p">:</span>
                    <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">requestId</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">[</span><span class="n">requestId</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unknown request </span><span class="si">%s</span><span class="s1"> - cannot set exception&#39;</span><span class="p">,</span> <span class="n">requestId</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">exc</span>
            <span class="k">if</span> <span class="n">set_and_forget</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__request_mark_sent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set send time &amp; clear exception from request if set, ignoring non-existent requests&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">[</span><span class="n">requestId</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># request might have had a response already have been removed by receiving thread</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">req</span><span class="o">.</span><span class="n">_send_time</span> <span class="o">=</span> <span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qmsg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True unless sending failed (at which point an exception will have been set in the request)&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum_lock</span><span class="p">:</span>
            <span class="n">seqnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">_SEQ_WRAP_SIZE</span>
        <span class="c1">#</span>
        <span class="n">innermsg</span> <span class="o">=</span> <span class="n">ubjdumpb</span><span class="p">(</span><span class="n">qmsg</span><span class="o">.</span><span class="n">inner_msg</span><span class="p">)</span>
        <span class="n">clevel</span> <span class="o">=</span> <span class="n">COMP_NONE</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">innermsg</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__comp_size</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Compressing payload&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">innermsg</span> <span class="o">=</span> <span class="n">COMPRESSORS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__comp_default</span><span class="p">]</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">innermsg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unknown compression method </span><span class="si">%s</span><span class="s1">, not compressing&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__comp_default</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__comp_default</span>

        <span class="n">p</span> <span class="o">=</span> <span class="p">{</span><span class="n">W_SEQ</span><span class="p">:</span> <span class="n">seqnum</span><span class="p">,</span>
             <span class="n">W_MESSAGE</span><span class="p">:</span> <span class="n">innermsg</span><span class="p">,</span>
             <span class="n">W_HASH</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_hash</span><span class="p">(</span><span class="n">innermsg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__token</span><span class="p">,</span> <span class="n">seqnum</span><span class="p">),</span>
             <span class="n">W_COMPRESSION</span><span class="p">:</span> <span class="n">clevel</span><span class="p">}</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">ubjdumpb</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># do not send messages exceeding size limit</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">VALIDATION_MAX_ENCODED_LENGTH</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__request_except</span><span class="p">(</span><span class="n">qmsg</span><span class="o">.</span><span class="n">requestId</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Message Payload too large </span><span class="si">%d</span><span class="s2"> &gt; </span><span class="si">%d</span><span class="s2">&quot;</span>
                                                             <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">VALIDATION_MAX_ENCODED_LENGTH</span><span class="p">)))</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/ubjson&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG_ENABLED</span><span class="p">:</span>
            <span class="n">p</span><span class="p">[</span><span class="n">W_MESSAGE</span><span class="p">]</span> <span class="o">=</span> <span class="n">qmsg</span><span class="o">.</span><span class="n">inner_msg</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">decode_sent_msg</span><span class="p">(</span><span class="s1">&#39;decode_sent_msg&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
        <span class="c1"># Callback any debuggers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_SEND</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="nd">@profiled_thread</span>  <span class="c1"># noqa (complexity)</span>
    <span class="k">def</span> <span class="nf">__network_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="n">queue_get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span><span class="o">.</span><span class="n">get</span>
        <span class="n">queue_task_done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span><span class="o">.</span><span class="n">task_done</span>
        <span class="n">retry_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_timeout</span>
        <span class="n">end_is_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">is_set</span>
        <span class="n">qmsg</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">end_is_set</span><span class="p">():</span>
            <span class="c1"># retrieve next message</span>
            <span class="k">if</span> <span class="n">qmsg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">qmsg</span> <span class="o">=</span> <span class="n">queue_get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">requestId</span> <span class="o">=</span> <span class="n">qmsg</span><span class="o">.</span><span class="n">requestId</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># wait before retrying previously failed request</span>
                <span class="k">if</span> <span class="n">retry_timeout</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">0.5</span><span class="p">):</span>
                        <span class="c1"># shutting down</span>
                        <span class="k">break</span>

            <span class="k">if</span> <span class="n">retry_timeout</span> <span class="ow">and</span> <span class="n">qmsg</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">retry_timeout</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;requestId &#39;</span><span class="si">%s</span><span class="s2">&#39; timeout after </span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">requestId</span><span class="p">,</span> <span class="n">retry_timeout</span><span class="p">)</span>
                <span class="c1"># note: previously set exception is preserved</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__request_except</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__send_throttle</span><span class="p">():</span>
                    <span class="c1"># end event (shutdown) set during throttling</span>
                    <span class="k">break</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">published</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__publish</span><span class="p">(</span><span class="n">qmsg</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">LinkException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to send &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">requestId</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">retry_timeout</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__request_except</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">set_and_forget</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                        <span class="c1"># request will be retried (assuming timeout is not reached after delay)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__request_except</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if not published, an exception will have been set on the request already</span>
                    <span class="k">if</span> <span class="n">published</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sent request &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">requestId</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__request_mark_sent</span><span class="p">(</span><span class="n">requestId</span><span class="p">)</span>

            <span class="n">queue_task_done</span><span class="p">()</span>
            <span class="n">qmsg</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__send_throttle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if end event was set during throttling-wait&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">throttler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_throttlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">throttler</span><span class="o">.</span><span class="n">throttle</span><span class="p">():</span>
                <span class="c1"># end event was set</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__fire_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if at least one callback was called&quot;&quot;&quot;</span>
        <span class="n">called</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">plain_submit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span><span class="o">.</span><span class="n">submit</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">:</span>
            <span class="n">submit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__crud_threadpool</span><span class="o">.</span><span class="n">submit</span> <span class="k">if</span> <span class="n">type_</span> <span class="ow">in</span> <span class="n">_CB_CRUD_TYPES</span> <span class="k">else</span> <span class="n">plain_submit</span>
            <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">[</span><span class="n">type_</span><span class="p">]:</span>
                <span class="n">called</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c1"># allow CRUD callbacks to not be serialised if requested</span>
                <span class="p">(</span><span class="n">submit</span> <span class="k">if</span> <span class="n">serialised_if_crud</span> <span class="k">else</span> <span class="n">plain_submit</span><span class="p">)(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">called</span>

    <span class="k">def</span> <span class="nf">__dispatch_ka</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Keep alive from container&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_KA</span><span class="p">)</span>

    <span class="n">__msg_wrapper_keys</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">W_SEQ</span><span class="p">,</span> <span class="n">W_COMPRESSION</span><span class="p">,</span> <span class="n">W_MESSAGE</span><span class="p">,</span> <span class="n">W_HASH</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__valid_msg_wrapper</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span>
                <span class="c1"># Python v2 doesn&#39;t support views, so cast to set</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="n">cls</span><span class="o">.</span><span class="n">__msg_wrapper_keys</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapper</span><span class="p">[</span><span class="n">W_SEQ</span><span class="p">],</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapper</span><span class="p">[</span><span class="n">W_MESSAGE</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapper</span><span class="p">[</span><span class="n">W_COMPRESSION</span><span class="p">],</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapper</span><span class="p">[</span><span class="n">W_HASH</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">))</span>

    <span class="n">__msg_body_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">OrderedDict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
    <span class="n">__msg_body_keys</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">M_CLIENTREF</span><span class="p">,</span> <span class="n">M_TYPE</span><span class="p">,</span> <span class="n">M_PAYLOAD</span><span class="p">))</span>
    <span class="n">__msg_body_payload_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">OrderedDict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>
    <span class="n">__msg_body_clientref_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">unicode_type</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__valid_msg_body</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__msg_body_types</span><span class="p">)</span> <span class="ow">and</span>
                <span class="c1"># Python v2 doesn&#39;t support views, so cast to set</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="n">cls</span><span class="o">.</span><span class="n">__msg_body_keys</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">],</span> <span class="n">cls</span><span class="o">.</span><span class="n">__msg_body_clientref_types</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">],</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">],</span> <span class="n">cls</span><span class="o">.</span><span class="n">__msg_body_payload_types</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__validate_decode_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>  <span class="c1"># noqa (complexity) pylint: disable=too-many-return-statements,too-many-branches</span>
        <span class="sd">&quot;&quot;&quot;Decodes wrapper, check hash &amp; seq, decodes body. Returns body or None, if validation / unpack failed&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_CONTENT_TYPE_PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content_type</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Message with unexpected content type </span><span class="si">%s</span><span class="s1"> from container, ignoring&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">content_type</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Message without content type from container, ignoring&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># Decode &amp; check message wrapper</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">ubjloadb</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed to decode message wrapper, ignoring&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">DEBUG_ENABLED</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_msg_wrapper</span><span class="p">(</span><span class="n">body</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid message wrapper, ignoring&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># currently only warn although maybe this should be an error</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cnt_seqnum</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_seqnum</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="n">W_SEQ</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cnt_seqnum</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unexpected seqnum from container: </span><span class="si">%d</span><span class="s1"> (last seen: </span><span class="si">%d</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">[</span><span class="n">W_SEQ</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">__cnt_seqnum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cnt_seqnum</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="n">W_SEQ</span><span class="p">]</span>

        <span class="c1"># Check message hash</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__check_hash</span><span class="p">(</span><span class="n">body</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Message has invalid hash, ignoring&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Decompress inner message</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">COMPRESSORS</span><span class="p">[</span><span class="n">body</span><span class="p">[</span><span class="n">W_COMPRESSION</span><span class="p">]]</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="n">W_MESSAGE</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Received message with unknown compression: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">[</span><span class="n">W_COMPRESSION</span><span class="p">])</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">OversizeException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Uncompressed message exceeds </span><span class="si">%d</span><span class="s1"> bytes, ignoring&#39;</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">DEBUG_ENABLED</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Decompression failed, ignoring message&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">DEBUG_ENABLED</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Decode inner message</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">ubjloadb</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed to decode message, ignoring&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">DEBUG_ENABLED</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_msg_body</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">body</span><span class="p">[</span><span class="n">W_SEQ</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Message with invalid body, ignoring: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__dispatch_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the signature and update RequestEvents / perform callbacks</span>

<span class="sd">        Note messages with an invalid wrapper, invalid hash, invalid sequence number or unexpected clientRef</span>
<span class="sd">        will be sent to debug_bad callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__validate_decode_msg</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">,</span> <span class="n">seqnum</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_BAD</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">content_type</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">DEBUG_ENABLED</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">decode_rcvd_msg</span><span class="p">(</span><span class="s1">&#39;decode_rcvd_msg&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">seqnum</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_RCVD</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="c1"># no reference, or set by client (not container)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_RSP_CONTAINER_REF</span><span class="p">:</span>
            <span class="c1"># solicitied</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__handle_known_solicited</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Ignoring response for unknown request </span><span class="si">%s</span><span class="s1"> of type </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">])</span>
            <span class="c1"># unsolicitied</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__perform_unsolicited_callbacks</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># unsolicited but can have reference set by container</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">E_CONTROLREQ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__handle_controlreq</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unhandled unsolicited message of type </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__handle_known_solicited</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns True if message has been handled as a solicited response&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__handle_low_seq_resend</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>

            <span class="n">perform_cb</span> <span class="o">=</span> <span class="n">finish</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_RSP_NO_REF</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__update_existing</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
                <span class="c1"># Finalise request if applicable (not marked as finished here so can perform callback first below)</span>
                <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_RSP_TYPE_FINISH</span><span class="p">:</span>
                    <span class="n">finish</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="c1"># Exception - DUPLICATED also should produce callback</span>
                    <span class="n">perform_cb</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">E_DUPLICATED</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_RSP_TYPE_ONGOING</span><span class="p">:</span>
                    <span class="n">perform_cb</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Reference unexpected for request </span><span class="si">%s</span><span class="s1"> of type </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">],</span>
                               <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">])</span>

        <span class="c1"># outside lock to avoid deadlock if callbacks try to perform request-related functions</span>
        <span class="k">if</span> <span class="n">perform_cb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__perform_unsolicited_callbacks</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># mark request as finished</span>
        <span class="k">if</span> <span class="n">finish</span><span class="p">:</span>
            <span class="n">req</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_RSP_TYPE_SUCCESS</span>
            <span class="n">req</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__clear_references</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="c1"># Serialise completion of CRUD requests (together with CREATED, DELETED, etc. messages)</span>
            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">is_crud</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__crud_threadpool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">_set</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">_set</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__clear_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">remove_request</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove any internal references to the given request&quot;&quot;&quot;</span>
        <span class="c1"># remove request itself</span>
        <span class="k">if</span> <span class="n">remove_request</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id_</span><span class="p">)</span>
        <span class="c1"># remove request type specific references</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id_</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id_</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__update_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Propagate changes based on type of message. MUST be called within self.__requests lock. Performs additional</span>
<span class="sd">           actions when solicited messages arrive.&quot;&quot;&quot;</span>
        <span class="n">req</span><span class="o">.</span><span class="n">_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_RSP_TYPE_CREATION</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_RESOURCE</span><span class="p">]</span> <span class="o">==</span> <span class="n">R_SUB</span><span class="p">:</span>
                <span class="c1"># Add callback for feeddata</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">:</span>
                        <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_POINT_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">R_FEED</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">[</span><span class="n">_CB_FEED</span><span class="p">][</span><span class="n">payload</span><span class="p">[</span><span class="n">P_POINT_ID</span><span class="p">]]</span> <span class="o">=</span> <span class="n">callback</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Subscription intended to feed is actually control: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_POINT_ID</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_RESOURCE</span><span class="p">]</span> <span class="o">==</span> <span class="n">R_CONTROL</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="p">:</span>
                        <span class="c1"># callbacks by thing</span>
                        <span class="n">entity_point_callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">[</span><span class="n">_CB_CONTROL</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="n">P_ENTITY_LID</span><span class="p">],</span> <span class="p">{})</span>
                        <span class="c1"># callback by thing and point</span>
                        <span class="n">entity_point_callbacks</span><span class="p">[</span><span class="n">payload</span><span class="p">[</span><span class="n">P_LID</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">E_RECENTDATA</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_SAMPLES</span><span class="p">]:</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__decode_data_time</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
                <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_RECENT_DATA</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">],</span>
                                                   <span class="s1">&#39;samples&#39;</span><span class="p">:</span> <span class="n">samples</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">__handle_low_seq_resend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;special error case - low sequence number (update sequence number &amp; resend if applicable). Returns True if</span>
<span class="sd">           a resend was scheduled, False otherwise. MUST be called within self.__requests lock.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">E_FAILED</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">][</span><span class="n">P_CODE</span><span class="p">]</span> <span class="o">==</span> <span class="n">E_FAILED_CODE_LOWSEQNUM</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum_lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">][</span><span class="n">P_MESSAGE</span><span class="p">])</span>
            <span class="c1"># return value indicating shutdown not useful here since this is run in receiver thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__retry_enqueue</span><span class="p">(</span><span class="n">PreparedMessage</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">_inner_msg_out</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">id_</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="n">__share_time_fmt</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">Z&#39;</span>

    <span class="k">def</span> <span class="nf">__decode_data_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract time and decode payload (based on mime type) from payload. Applies to E_FEEDDATA and E_RECENTDATA.</span>
<span class="sd">        Returns tuple of data, mime, time.&quot;&quot;&quot;</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">mime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bytes_to_share_data</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">P_TIME</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__share_time_fmt</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Share payload from container has invalid timestamp (</span><span class="si">%s</span><span class="s1">), will use naive local time&#39;</span><span class="p">,</span>
                           <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">P_TIME</span><span class="p">))</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">time</span>

    <span class="k">def</span> <span class="nf">__perform_unsolicited_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callbacks for which a client reference is either optional or does not apply at all&quot;&quot;&quot;</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">]</span>

        <span class="c1"># callbacks for responses which might be unsolicited (e.g. created or deleted)</span>
        <span class="k">if</span> <span class="n">type_</span> <span class="ow">in</span> <span class="n">_RSP_PAYLOAD_CB_MAPPING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_RSP_PAYLOAD_CB_MAPPING</span><span class="p">[</span><span class="n">type_</span><span class="p">],</span> <span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Perform callbacks for feed data</span>
        <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="n">E_FEEDDATA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__simulate_feeddata</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="n">P_FEED_ID</span><span class="p">],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__decode_data_time</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>

        <span class="c1"># Perform callbacks for unsolicited subscriber message</span>
        <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="n">E_SUBSCRIBED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_SUBSCRIPTION</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unexpected message type for unsolicited callback </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">
    <h2 class="section-title" id="header-variables">Module variables</h2>
      <div class="item">
      <p id="IoticAgent.Core.Client.COMPRESSORS" class="name">var <span class="ident">COMPRESSORS</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.COMP_DEFAULT" class="name">var <span class="ident">COMP_DEFAULT</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.COMP_LZ4F" class="name">var <span class="ident">COMP_LZ4F</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.COMP_NONE" class="name">var <span class="ident">COMP_NONE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.COMP_SIZE" class="name">var <span class="ident">COMP_SIZE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.C_CREATE" class="name">var <span class="ident">C_CREATE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.C_DELETE" class="name">var <span class="ident">C_DELETE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.C_LIST" class="name">var <span class="ident">C_LIST</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.C_UPDATE" class="name">var <span class="ident">C_UPDATE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.DEBUG_ENABLED" class="name">var <span class="ident">DEBUG_ENABLED</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.E_COMPLETE" class="name">var <span class="ident">E_COMPLETE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.E_CONTROLREQ" class="name">var <span class="ident">E_CONTROLREQ</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.E_CREATED" class="name">var <span class="ident">E_CREATED</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.E_DELETED" class="name">var <span class="ident">E_DELETED</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.E_DUPLICATED" class="name">var <span class="ident">E_DUPLICATED</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.E_FAILED" class="name">var <span class="ident">E_FAILED</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.E_FAILED_CODE_LOWSEQNUM" class="name">var <span class="ident">E_FAILED_CODE_LOWSEQNUM</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.E_FEEDDATA" class="name">var <span class="ident">E_FEEDDATA</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.E_PROGRESS" class="name">var <span class="ident">E_PROGRESS</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.E_REASSIGNED" class="name">var <span class="ident">E_REASSIGNED</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.E_RECENTDATA" class="name">var <span class="ident">E_RECENTDATA</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.E_RENAMED" class="name">var <span class="ident">E_RENAMED</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.E_SUBSCRIBED" class="name">var <span class="ident">E_SUBSCRIBED</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.M_ACTION" class="name">var <span class="ident">M_ACTION</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.M_CLIENTREF" class="name">var <span class="ident">M_CLIENTREF</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.M_PAYLOAD" class="name">var <span class="ident">M_PAYLOAD</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.M_RANGE" class="name">var <span class="ident">M_RANGE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.M_RESOURCE" class="name">var <span class="ident">M_RESOURCE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.M_TYPE" class="name">var <span class="ident">M_TYPE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.PY3" class="name">var <span class="ident">PY3</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.P_CODE" class="name">var <span class="ident">P_CODE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.P_DATA" class="name">var <span class="ident">P_DATA</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.P_ENTITY_LID" class="name">var <span class="ident">P_ENTITY_LID</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.P_FEED_ID" class="name">var <span class="ident">P_FEED_ID</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.P_LID" class="name">var <span class="ident">P_LID</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.P_MESSAGE" class="name">var <span class="ident">P_MESSAGE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.P_MIME" class="name">var <span class="ident">P_MIME</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.P_POINT_ID" class="name">var <span class="ident">P_POINT_ID</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.P_POINT_TYPE" class="name">var <span class="ident">P_POINT_TYPE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.P_RESOURCE" class="name">var <span class="ident">P_RESOURCE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.P_SAMPLES" class="name">var <span class="ident">P_SAMPLES</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.P_TIME" class="name">var <span class="ident">P_TIME</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_CONTROL" class="name">var <span class="ident">R_CONTROL</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_CONTROL_META" class="name">var <span class="ident">R_CONTROL_META</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_CONTROL_TAG_META" class="name">var <span class="ident">R_CONTROL_TAG_META</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_DESCRIBE" class="name">var <span class="ident">R_DESCRIBE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_ENTITY" class="name">var <span class="ident">R_ENTITY</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_ENTITY_META" class="name">var <span class="ident">R_ENTITY_META</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_ENTITY_TAG_META" class="name">var <span class="ident">R_ENTITY_TAG_META</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_FEED" class="name">var <span class="ident">R_FEED</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_FEED_META" class="name">var <span class="ident">R_FEED_META</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_FEED_TAG_META" class="name">var <span class="ident">R_FEED_TAG_META</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_PING" class="name">var <span class="ident">R_PING</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_SEARCH" class="name">var <span class="ident">R_SEARCH</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_SUB" class="name">var <span class="ident">R_SUB</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.R_VALUE_META" class="name">var <span class="ident">R_VALUE_META</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.VALIDATION_MAX_ENCODED_LENGTH" class="name">var <span class="ident">VALIDATION_MAX_ENCODED_LENGTH</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.W_COMPRESSION" class="name">var <span class="ident">W_COMPRESSION</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.W_HASH" class="name">var <span class="ident">W_HASH</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.W_MESSAGE" class="name">var <span class="ident">W_MESSAGE</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.W_SEQ" class="name">var <span class="ident">W_SEQ</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.int_types" class="name">var <span class="ident">int_types</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.logger" class="name">var <span class="ident">logger</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.ubj_ext" class="name">var <span class="ident">ubj_ext</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="IoticAgent.Core.Client.ubj_version" class="name">var <span class="ident">ubj_version</span></p>
      
  
  <div class="source_cont">
</div>

      </div>


    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="IoticAgent.Core.Client.Client" class="name">class <span class="ident">Client</span></p>
      
  
    <div class="desc"><p>Iotic Labs QAPI Client</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client" class="source">
    <div class="codehilite"><pre><span class="k">class</span> <span class="nc">Client</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-instance-attributes,too-many-public-methods</span>
    <span class="sd">&quot;&quot;&quot;Iotic Labs QAPI Client</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># QAPI version targeted by Core client</span>
    <span class="n">__qapi_version</span> <span class="o">=</span> <span class="s1">&#39;1.2.0&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">vhost</span><span class="p">,</span> <span class="n">epId</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>  <span class="c1"># pylint: disable=too-many-locals</span>
                 <span class="n">sslca</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">network_retry_timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">socket_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">auto_encode_decode</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">send_queue_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                 <span class="n">throttle_conf</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        `host` amqp broker &quot;host:port&quot;</span>

<span class="sd">        `vhost` amqp broker virtual host</span>

<span class="sd">        `epId` amqp username</span>

<span class="sd">        `passwd` amqp broker password</span>

<span class="sd">        `token` ascii hex token secret</span>

<span class="sd">        `prefix` epId prefix depends on container settings</span>

<span class="sd">        `lang` language code to use for relevant (meta data) requests. If not set, the container</span>
<span class="sd">               container default will be used. See also default_lang.</span>

<span class="sd">        `sslca` path to file of broker SSL Certificate (IF NOT using Public)</span>

<span class="sd">        `network_retry_timeout` If 0 no retry/timeout else seconds.</span>

<span class="sd">        `socket_timeout` Underlying socket connection/operation timeout</span>

<span class="sd">        `auto_encode_decode` Automatically encode/decode text (utf8) and dictionaries (ubjson) when</span>
<span class="sd">                             sending/receiving point data. When sending, only applies if mime type not specified.</span>

<span class="sd">        `send_queue_size` Maximum number of unsent requets to keep in interval queue. The queue can reach</span>
<span class="sd">                          its size limit when using asynchronous requests AND either `throttle_conf` is</span>
<span class="sd">                          used or if the the client has not been connected to the container for a while</span>
<span class="sd">                          (due to network problems). Set to zero for no limit.</span>

<span class="sd">        `throttle_conf` Automatic request (outgoing) throttling, specified as comma-separate list of</span>
<span class="sd">                        REQUESTS/INTERVAL pairs. E.g. &#39;180/60,600/300&#39; would result in no more than 180</span>
<span class="sd">                        requests being sent over the last 60 seconds and no more than 600 requests over the</span>
<span class="sd">                        last 5 minutes. Used to prevent rate-limiting containers from temporarily banning</span>
<span class="sd">                        the client without requiring application code to introduce artificial delays.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ubjson version: </span><span class="si">%s</span><span class="s1"> (extension </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">ubj_version</span><span class="p">,</span> <span class="s1">&#39;enabled&#39;</span> <span class="k">if</span> <span class="n">ubj_ext</span> <span class="k">else</span> <span class="s1">&#39;disabled&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;__init__ config host=&#39;</span><span class="si">%s</span><span class="s2">&#39;, vhost=&#39;</span><span class="si">%s</span><span class="s2">&#39;, epId=&#39;</span><span class="si">%s</span><span class="s2">&#39;, passwd=&#39;</span><span class="si">%s</span><span class="s2">&#39;, token=&#39;</span><span class="si">%s</span><span class="s2">&#39;, prefix=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                     <span class="s2">&quot; , sslca=&#39;</span><span class="si">%s</span><span class="s2">&#39; network_retry_timeout=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="n">host</span><span class="p">,</span> <span class="n">vhost</span><span class="p">,</span> <span class="n">epId</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">sslca</span><span class="p">,</span> <span class="n">network_retry_timeout</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">epId</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lang_check_convert</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__local_meta</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1">#</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__token</span> <span class="o">=</span> <span class="n">a2b_hex</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="n">raise_from</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;token invalid&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
        <span class="c1"># seq (from this client)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># request id numeric component</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__reqnum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;vhost&#39;</span><span class="p">,</span> <span class="s1">&#39;passwd&#39;</span><span class="p">):</span>
            <span class="n">Validation</span><span class="o">.</span><span class="n">check_convert_string</span><span class="p">(</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
        <span class="c1"># Only applies until ping response (see start() method)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_compression</span><span class="p">(</span><span class="n">comp</span><span class="o">=</span><span class="n">COMP_NONE</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__reqpre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rnd_string</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__auto_encode_decode</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">auto_encode_decode</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span> <span class="o">=</span> <span class="n">AmqpLink</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">vhost</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dispatch_msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dispatch_ka</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">__send_ready_cb</span><span class="p">,</span> <span class="n">sslca</span><span class="o">=</span><span class="n">sslca</span><span class="p">,</span>
                                   <span class="n">socket_timeout</span><span class="o">=</span><span class="n">validate_nonnegative_int</span><span class="p">(</span><span class="n">socket_timeout</span><span class="p">,</span> <span class="s1">&#39;socket_timeout&#39;</span><span class="p">,</span>
                                                                           <span class="n">allow_zero</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="c1"># seq (from container - initial value used to surpress warning on first message from container)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cnt_seqnum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># (Core.Client has not been .start or is .stop)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__end</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="c1"># Timer used to retry sending of requests which might not have reached the broker (dummy instance set here)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="c1"># network_retry thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_timeout</span> <span class="o">=</span> <span class="n">validate_nonnegative_int</span><span class="p">(</span><span class="n">network_retry_timeout</span><span class="p">,</span> <span class="s1">&#39;network_retry_timeout&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue_size</span> <span class="o">=</span> <span class="n">validate_nonnegative_int</span><span class="p">(</span><span class="n">send_queue_size</span><span class="p">,</span> <span class="s1">&#39;send_queue_size&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_throttlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_throttlers</span><span class="p">(</span><span class="n">throttle_conf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="p">)</span>
        <span class="c1"># __requests stores all incoming messages {&#39;requestId&#39;: event}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span> <span class="o">=</span> <span class="n">ThreadSafeDict</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># Remember pending subscriptions &amp; control callbacks.  __dispatch_msg will bind them when CREATED.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span> <span class="o">=</span> <span class="n">ThreadSafeDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span> <span class="o">=</span> <span class="n">ThreadSafeDict</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># __callbacks stores (un)solicited message registered callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span> <span class="o">=</span> <span class="n">ThreadSafeDict</span><span class="p">((</span><span class="n">type_</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">type_</span> <span class="ow">in</span>
                                          <span class="p">(</span><span class="n">_CB_DEBUG_KA</span><span class="p">,</span> <span class="n">_CB_DEBUG_SEND</span><span class="p">,</span> <span class="n">_CB_DEBUG_BAD</span><span class="p">,</span> <span class="n">_CB_DEBUG_RCVD</span><span class="p">,</span> <span class="n">_CB_CREATED</span><span class="p">,</span>
                                           <span class="n">_CB_DUPLICATE</span><span class="p">,</span> <span class="n">_CB_RENAMED</span><span class="p">,</span> <span class="n">_CB_DELETED</span><span class="p">,</span> <span class="n">_CB_FEEDDATA</span><span class="p">,</span> <span class="n">_CB_CONTROLREQ</span><span class="p">,</span>
                                           <span class="n">_CB_REASSIGNED</span><span class="p">,</span> <span class="n">_CB_SUBSCRIPTION</span><span class="p">,</span> <span class="n">_CB_RECENT_DATA</span><span class="p">))</span>
        <span class="c1"># mappings of pointId -&gt; callback list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">type_</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">type_</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_CB_FEED</span><span class="p">,</span> <span class="n">_CB_CONTROL</span><span class="p">)})</span>
        <span class="c1">#</span>
        <span class="c1"># Background thread for forwarding resource CRUD related events, including completion of CRUD requests</span>
        <span class="c1"># All such callbacks happen in a single thread so ordering of potentially related events is consistent.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__crud_threadpool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">daemonic</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Callback threadpool for any callbacks not covered by CRUD thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">daemonic</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Store container params from request_ping response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__container_params</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__create_throttlers</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">end_event</span><span class="p">):</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">check_convert_string</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;throttle_conf&#39;</span><span class="p">,</span> <span class="n">no_whitespace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">min_len</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
        <span class="n">throttlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">part</span><span class="p">:</span>
                    <span class="n">iterations</span><span class="p">,</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="c1"># use end_event so that throttling does not delay shutdown</span>
                    <span class="n">throttlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RateLimiter</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">interval</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">iterations</span><span class="p">),</span> <span class="n">wait_cmd</span><span class="o">=</span><span class="n">end_event</span><span class="o">.</span><span class="n">wait</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">raise_from</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;throttle_conf invalid&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">throttlers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">epId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;EP/Agent id in use for this client&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_lang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Language in use when not explicitly specified (in meta related requests). Will be set to container default</span>
<span class="sd">        if was not set in constructor. Before calling start() this might be None.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Whether container-local metadata functionality (e.g. search) is available in this container. Before calling</span>
<span class="sd">        start() this will always be False.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__local_meta</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">container_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns container configuration parameters as a mapping. Will be empty before start() has been called&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__container_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__container_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">restore_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;restore an event based on the requestId.</span>

<span class="sd">        For example if the user app had to shutdown with pending requests.</span>
<span class="sd">        The user can rebuild the Events they were waiting for based on the requestId(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">requestId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">[</span><span class="n">requestId</span><span class="p">]</span> <span class="o">=</span> <span class="n">RequestEvent</span><span class="p">(</span><span class="n">requestId</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sync_if_crud indicates whether to serialise this callback (applies only to CRUD)&quot;&quot;&quot;</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">callable_check</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">[</span><span class="n">type_</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">register_callback_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (resource) CREATED. The</span>
<span class="sd">        callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">        the callbacks might arrive out-of-order (e.g. created point before created thing).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_CREATED</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (resource) DUPLICATE. The</span>
<span class="sd">        callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">        the callbacks might arrive out-of-order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DUPLICATE</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_renamed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (resource) RENAMED. The</span>
<span class="sd">        callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">        the callbacks might arrive out-of-order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_RENAMED</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (resource) DELETED. The</span>
<span class="sd">        callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">        the callbacks might arrive out-of-order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DELETED</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_reassigned</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (entity) REASSIGNED. The</span>
<span class="sd">        callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">        the callbacks might arrive out-of-order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_REASSIGNED</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive subscription count changes. The callback receives</span>
<span class="sd">        a single argument - a dict with r, the resource type (R_FEED or R_CONTROL), entityLid (the</span>
<span class="sd">        nickname of the thing to which the point belongs), lid (the nickname of the point) and</span>
<span class="sd">        subCount (the current subscription count). Note: Subscription count changes can occur for</span>
<span class="sd">        each new (or deleted) subscription.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_SUBSCRIPTION</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_recent_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to receive recent data samples. The callback receives</span>
<span class="sd">        a single argument - a dict with c, the reference to the original request, pointId, the</span>
<span class="sd">        id of the point to which the data applies, and samples, a list of dicts containing time</span>
<span class="sd">        (the timestamp of the recent data sample), mime and data. If auto_encode_decode is enabled,</span>
<span class="sd">        the data &amp; mime fields might be modified.&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_RECENT_DATA</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_debug_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function for every sent message, including on retries. The callback</span>
<span class="sd">           receives a single argument - the sent message in raw byte form.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_SEND</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_debug_rcvd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to every GOOD recieved message. The callback receives a single</span>
<span class="sd">        argument - the unwrapped message as a dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_RCVD</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_debug_bad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to every BAD received message (EG bad sign). The callback</span>
<span class="sd">        receives two arguments - the received message in raw byte form and the content type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_BAD</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_feeddata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to every FEEDDATA message! The callback receives a single</span>
<span class="sd">        dict argument, with keys of &#39;data&#39; (decoded or raw bytes), &#39;mime&#39; (None, unless payload</span>
<span class="sd">        was not decoded and has a mime type) and &#39;pid&#39; (the global id of the feed from which</span>
<span class="sd">        the data originates).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_FEEDDATA</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_callback_controlreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a callback function to every CONTROLREQ message! The callback receives a single</span>
<span class="sd">        dict argument, with keys of &#39;data&#39; (decoded or raw bytes), &#39;mime&#39; (None, unless payload</span>
<span class="sd">        was not decoded and has a mime type), &#39;subId&#39; (the global id of the associated subscripion),</span>
<span class="sd">        &#39;entityLid&#39; (local id of the thing to which the control belongs), &#39;lid&#39; (local id of</span>
<span class="sd">        control), &#39;confirm&#39; (whether a confirmation is expected) and &#39;requestId&#39; (required for</span>
<span class="sd">        sending confirmation).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_CONTROLREQ</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">simulate_feeddata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send feed data&quot;&quot;&quot;</span>
        <span class="c1"># Separate public method since internal one does not require parameter checks</span>
        <span class="n">feedid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">feedid</span><span class="p">)</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">mime_check_convert</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">datetime_check_convert</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">to_iso8601</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__simulate_feeddata</span><span class="p">(</span><span class="n">feedid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">time</span><span class="p">)</span>

    <span class="c1"># Used by both simulate_feeddata() and internally to propagate feed data</span>
    <span class="k">def</span> <span class="nf">__simulate_feeddata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
               <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">feedid</span><span class="p">,</span>
               <span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">,</span>
               <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">}</span>

        <span class="c1"># general catch-all</span>
        <span class="n">have_general</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_FEEDDATA</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="c1"># just for this feed</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">[</span><span class="n">_CB_FEED</span><span class="p">][</span><span class="n">feedid</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">have_general</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Received Feed Data for Point GUID &#39;</span><span class="si">%s</span><span class="s2">&#39; but no callback registered.&quot;</span><span class="p">,</span> <span class="n">feedid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

    <span class="c1"># Unlike simulate_feeddata this attempts to decode!</span>
    <span class="k">def</span> <span class="nf">__handle_controlreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">requestId</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">mime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bytes_to_share_data</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">arg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;requestId&#39;</span><span class="p">:</span> <span class="n">requestId</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                    <span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">})</span>

        <span class="c1"># general catch-all</span>
        <span class="n">have_general</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_CONTROLREQ</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="c1"># just for this control</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">[</span><span class="n">_CB_CONTROL</span><span class="p">][</span><span class="n">payload</span><span class="p">[</span><span class="n">P_ENTITY_LID</span><span class="p">]][</span><span class="n">payload</span><span class="p">[</span><span class="n">P_LID</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">have_general</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Received Control Request for </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2"> but no callback registered.&quot;</span><span class="p">,</span>
                               <span class="n">payload</span><span class="p">[</span><span class="n">P_ENTITY_LID</span><span class="p">],</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_LID</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa (complexity)</span>
        <span class="sd">&quot;&quot;&quot;Start the send &amp; recv Threads.</span>
<span class="sd">        Start can be delayed to EG restore requestIds before attaching to the QAPI</span>
<span class="sd">        Note: This function waits for/blocks until amqplink connect(s) and the current</span>
<span class="sd">              sequence number has been obtained from the container (within 5 seconds)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__network_retry</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;network&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="n">raise_from</span><span class="p">(</span><span class="n">LinkException</span><span class="p">(</span><span class="s2">&quot;Core.AmqpLink: Failed to connect&quot;</span><span class="p">),</span> <span class="n">exc</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Unhandled startup error&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

            <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_ping</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">LinkException</span><span class="p">(</span><span class="s2">&quot;No container response to ping within 5s&quot;</span><span class="p">)</span>
            <span class="c1"># (for req.payload) pylint: disable=unsubscriptable-object</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">req</span><span class="o">.</span><span class="n">payload</span><span class="p">[</span><span class="n">P_MESSAGE</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unexpected ping failure: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">info</span><span class="p">)</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">payload</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__qapi_version_check</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__container_params</span> <span class="o">=</span> <span class="n">payload</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_compression</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">raise_from</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Container compression method (</span><span class="si">%d</span><span class="s1">) unsupported&#39;</span> <span class="o">%</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">]),</span> <span class="n">ex</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__local_meta</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;local_meta&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__crud_threadpool</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__qapi_version_check</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">qapi_version</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unable to perform version check - version not included&#39;</span><span class="p">)</span>

        <span class="n">qapi_str</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">qapi_version</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">version_string_to_tuple</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__qapi_version</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qapi_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;QAPI major version difference: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> expected)&#39;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">qapi_str</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__qapi_version</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">qapi_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">expected</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;QAPI minor version older: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> known)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qapi_str</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__qapi_version</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">qapi_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">expected</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;QAPI minor version difference: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> known)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qapi_str</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__qapi_version</span><span class="p">),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">qapi_version</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">expected</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;QAPI patch level change: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> known)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qapi_str</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__qapi_version</span><span class="p">),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;QAPI version: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">qapi_str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the Client, disconnect from queue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_timer</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__crud_threadpool</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="c1"># Clear out remaining pending requests</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
            <span class="n">shutdown</span> <span class="o">=</span> <span class="n">LinkShutdownException</span><span class="p">(</span><span class="s1">&#39;Client stopped&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">req</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">shutdown</span>
                <span class="n">req</span><span class="o">.</span><span class="n">_set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__clear_references</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">remove_request</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> unfinished request(s) discarded&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__container_params</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set_compression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="n">COMP_DEFAULT</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">COMP_SIZE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override compression method (defined by container) and threshold&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">comp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">COMPRESSORS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comp</span> <span class="o">==</span> <span class="n">COMP_LZ4F</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;lz4f compression not available, required lz4framed&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid compression method&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;size must be non-negative integer&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__comp_default</span> <span class="o">=</span> <span class="n">comp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__comp_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__comp_default</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__comp_size</span>

    <span class="k">def</span> <span class="nf">get_seqnum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__valid_seqnum</span><span class="p">(</span><span class="n">seqnum</span><span class="p">,</span> <span class="n">prev_seqnum</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">seqnum</span> <span class="o">&lt;</span> <span class="n">_SEQ_WRAP_SIZE</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">seqnum</span> <span class="o">-</span> <span class="n">prev_seqnum</span><span class="p">)</span> <span class="o">%</span> <span class="n">_SEQ_WRAP_SIZE</span> <span class="o">&lt;=</span> <span class="n">_SEQ_MAX_AHEAD</span>

    <span class="c1">#</span>
    <span class="c1"># Client request functions</span>
    <span class="c1">#</span>
    <span class="c1"># Note about naming of function args</span>
    <span class="c1">#  requestId = string unique</span>
    <span class="c1">#  lid = local name to user</span>
    <span class="c1">#  pid = local name to user</span>
    <span class="c1">#  foc = R_FEED or R_CONTROL used on point functions which accept both</span>
    <span class="c1">#  slid = subscribing lid (local only)</span>
    <span class="c1">#  gpid = guid of point EG to subscribe to</span>
    <span class="c1">#  sub_id = subscription ID used for ask/tell etc</span>
    <span class="c1">#  data = STRING of the data to share,ask,tell etc</span>
    <span class="c1">#  limit = int EG 50 (num rows)</span>
    <span class="c1">#  offset = int EG 0 (starting position)</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">requestId</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">is_crud</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;_request amqp queue publish helper</span>

<span class="sd">        return: RequestEvent object or None for failed to publish</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span>
        <span class="k">if</span> <span class="n">end</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Request made whilst client not running&#39;</span><span class="p">)</span>

        <span class="n">rng</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">Validation</span><span class="o">.</span><span class="n">limit_offset_check</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">requestId</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">requestId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__new_request_id</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">requestId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;requestId </span><span class="si">%s</span><span class="s1"> already in use&#39;</span> <span class="o">%</span> <span class="n">requestId</span><span class="p">)</span>
            <span class="n">inner_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_innermsg</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">requestId</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">[</span><span class="n">requestId</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">RequestEvent</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span> <span class="n">inner_msg</span><span class="p">,</span> <span class="n">is_crud</span><span class="o">=</span><span class="n">is_crud</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__retry_enqueue</span><span class="p">(</span><span class="n">PreparedMessage</span><span class="p">(</span><span class="n">inner_msg</span><span class="p">,</span> <span class="n">requestId</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">LinkShutdownException</span><span class="p">(</span><span class="s1">&#39;Client stopped&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="c1"># don&#39;t block shutdown on full send queue. returns True if did enqueue, False if shutting down</span>
    <span class="k">def</span> <span class="nf">__retry_enqueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">end_wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">wait</span>
        <span class="n">queue_put_nowait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span><span class="o">.</span><span class="n">put_nowait</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># don&#39;t block shutdown on full send queue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">queue_put_nowait</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Full</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">end_wait</span><span class="p">(</span><span class="o">.</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__send_ready_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_send_failure_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback from AmqpLink on send transport readiness. (Only ever comes from a single thread.)&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Readiness notification (last failed=</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">last_send_failure_time</span><span class="p">)</span>
        <span class="c1"># It is possible for multiple timers to be scheduled (if multiple transport failures happen in a fairly short</span>
        <span class="c1"># amount of time. See logic for __send_retry_requests</span>
        <span class="k">if</span> <span class="n">last_send_failure_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_timer</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="c1"># allow 10s for responses to come in before attempting to resend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">last_send_failure_time</span><span class="p">,))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__send_retry_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_send_failure_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called via Timer from __send_ready to resend requests which might not have been sent due to transport</span>
<span class="sd">           failure. This can happen since the current transport implementation does not received acknowledgements</span>
<span class="sd">           for sent messages.&quot;&quot;&quot;</span>
        <span class="c1"># make sure multiple failures having set multiple times do not run concurrently</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_lock</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="c1"># produce list instead of generator as requests mapping can change during subsequent loop</span>
                <span class="n">retry_reqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">req</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                              <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">_sent_without_response</span><span class="p">(</span><span class="n">last_send_failure_time</span><span class="p">)]</span>

            <span class="n">retry_req_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># don&#39;t continue if another network failure has occured (which will trigger this function again)</span>
            <span class="k">while</span> <span class="n">retry_reqs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span><span class="o">.</span><span class="n">last_send_exc_time</span> <span class="o">&lt;=</span> <span class="n">last_send_failure_time</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">retry_reqs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="c1"># lock individuallly so incoming request handling does not &#39;pause&#39; for too long</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                    <span class="c1"># might have received a response (or finished since)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">id_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span> <span class="ow">and</span> <span class="n">req</span><span class="o">.</span><span class="n">_sent_without_response</span><span class="p">(</span><span class="n">last_send_failure_time</span><span class="p">)):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not resending request </span><span class="si">%s</span><span class="s1"> (finished or has received response)&#39;</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">id_</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Resending request </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">id_</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__retry_enqueue</span><span class="p">(</span><span class="n">PreparedMessage</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">_inner_msg_out</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">id_</span><span class="p">)):</span>
                    <span class="c1"># client shutdown</span>
                    <span class="k">break</span>
                <span class="n">retry_req_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">retry_req_count</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Resending of </span><span class="si">%d</span><span class="s1"> request(s) complete (before </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">retry_req_count</span><span class="p">,</span> <span class="n">last_send_failure_time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_ping&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_PING</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">epId</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;request entity create: lid = local name to user</span>
<span class="sd">        If epId=None (default), the current agent/EP is chosen</span>
<span class="sd">        If epId=False, no agent is assigned</span>
<span class="sd">        If epId=guid, said agent is chosen</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">epId</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">epId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span>
        <span class="k">elif</span> <span class="n">epId</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">epId</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epId</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">epId</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_create lid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;epId&#39;</span><span class="p">:</span> <span class="n">epId</span><span class="p">,</span> <span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">lid</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">newlid</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">newlid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">newlid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_rename lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; -&gt; newlid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">newlid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">newlid</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_reassign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">nepId</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;request entity to be reassigned to given ep/agent</span>
<span class="sd">        If nepId=None (default), the current agent/EP is chosen</span>
<span class="sd">        If nepId=False, no agent is assigned</span>
<span class="sd">        If nepId=guid, said agent is chosen</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nepId</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nepId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span>
        <span class="k">elif</span> <span class="n">nepId</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">nepId</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nepId</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">nepId</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_reassign lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; -&gt; nepId=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">nepId</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="s1">&#39;reassign&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;epId&#39;</span><span class="p">:</span> <span class="n">nepId</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_delete lid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_DELETE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_list&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__epId</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_list_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_list_all&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_entity_meta_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">metafmt_check_convert</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_meta_get lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; fmt=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_META</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">request_entity_meta_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">metafmt_check_convert</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_meta_set lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; fmt=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_META</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="n">meta</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">fmt</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_entity_meta_setpublic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_meta_setpublic lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; public=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">public</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_META</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="s1">&#39;setPublic&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;public&#39;</span><span class="p">:</span> <span class="n">public</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_entity_tag_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">tags_check_convert</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="n">delete</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">bool_check_convert</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_tag_update lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; tags=</span><span class="si">%s</span><span class="s2"> delete=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_TAG_META</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="n">delete</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_entity_tag_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_tag_list lid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_TAG_META</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">control_cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">save_recent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;request point create: feed or control, lid and pid point lid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">save_recent</span> <span class="o">=</span> <span class="n">validate_int</span><span class="p">(</span><span class="n">save_recent</span><span class="p">,</span> <span class="s1">&#39;save_recent&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_create foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; save_recent=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">save_recent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">foc</span> <span class="o">==</span> <span class="n">R_CONTROL</span><span class="p">:</span>
            <span class="n">Validation</span><span class="o">.</span><span class="n">callable_check</span><span class="p">(</span><span class="n">control_cb</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save_recent</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ignoring non-zero save_recent value for control&#39;</span><span class="p">)</span>
            <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">pid</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_cb</span>
            <span class="k">return</span> <span class="n">evt</span>
        <span class="k">elif</span> <span class="n">control_cb</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;callback specified for Feed&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;saveRecent&#39;</span><span class="p">:</span> <span class="n">save_recent</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">newpid</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">newpid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">newpid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_rename foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; -&gt; newpid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">newpid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">newpid</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_confirm_tell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">requestId</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">bool_check_convert</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="n">success</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_confirm_tell foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; success=</span><span class="si">%s</span><span class="s2"> requestId=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span>
                     <span class="n">success</span><span class="p">,</span> <span class="n">requestId</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;confirm&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">success</span><span class="p">},</span> <span class="n">requestId</span><span class="o">=</span><span class="n">requestId</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_delete foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_DELETE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_list foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_list_detailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_list_detailed foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">request_point_recent_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_recent_info foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;recent&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">request_point_recent_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">max_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">max_samples</span> <span class="o">=</span> <span class="n">validate_int</span><span class="p">(</span><span class="n">max_samples</span><span class="p">,</span> <span class="s1">&#39;max_samples&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_recent_config foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;recent&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;maxSamples&#39;</span><span class="p">:</span> <span class="n">max_samples</span><span class="p">})</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__res_to_meta</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="n">R_FEED</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">R_FEED_META</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="o">==</span> <span class="n">R_CONTROL</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">R_CONTROL_META</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">request_point_meta_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">metafmt_check_convert</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="n">foc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__res_to_meta</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_meta_get foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; fmt=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">request_point_meta_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">):</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">metafmt_check_convert</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="n">foc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__res_to_meta</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_meta_set foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; fmt=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="n">meta</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">fmt</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_point_value_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">vtype</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">value_type_check_convert</span><span class="p">(</span><span class="n">vtype</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">label_check_convert</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lang_check_convert</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span><span class="p">)</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">comment_check_convert</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_value_create foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; label=</span><span class="si">%s</span><span class="s2"> vtype=</span><span class="si">%s</span><span class="s2"> lang=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span>
                     <span class="n">label</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_VALUE_META</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">),</span>
                             <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">vtype</span><span class="p">,</span> <span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_point_value_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">label_check_convert</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_value_delete foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; label=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_VALUE_META</span><span class="p">,</span> <span class="n">C_DELETE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">)</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">request_point_value_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_value_list foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_VALUE_META</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">),</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__point_type_to_tag_type</span><span class="p">(</span><span class="n">foc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">foc</span> <span class="o">==</span> <span class="n">R_FEED</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">R_FEED_TAG_META</span>
        <span class="k">elif</span> <span class="n">foc</span> <span class="o">==</span> <span class="n">R_CONTROL</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">R_CONTROL_TAG_META</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown point type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">foc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_point_tag_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">tags_check_convert</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="n">delete</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">bool_check_convert</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_tag_update foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; tags=</span><span class="si">%s</span><span class="s2"> delete=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__point_type_to_tag_type</span><span class="p">(</span><span class="n">foc</span><span class="p">),</span>
                             <span class="n">C_UPDATE</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span>
                             <span class="p">{</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="n">delete</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_point_tag_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_tag_list foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__point_type_to_tag_type</span><span class="p">(</span><span class="n">foc</span><span class="p">),</span>
                             <span class="n">C_LIST</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span>
                             <span class="bp">None</span><span class="p">,</span>
                             <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_sub_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">gpid</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">gpid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">foc</span> <span class="o">==</span> <span class="n">R_FEED</span><span class="p">:</span>
            <span class="n">Validation</span><span class="o">.</span><span class="n">callable_check</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Subscription for control cannot have callback&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_create foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; gpid=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">gpid</span><span class="p">)</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">gpid</span><span class="p">),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="k">return</span> <span class="n">evt</span>

    <span class="k">def</span> <span class="nf">request_sub_create_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">slid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">slid</span><span class="p">)</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">foc</span> <span class="o">==</span> <span class="n">R_FEED</span><span class="p">:</span>
            <span class="n">Validation</span><span class="o">.</span><span class="n">callable_check</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Subscription for control cannot have callback&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_create_local slid=</span><span class="si">%s</span><span class="s2"> foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">slid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">slid</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="k">return</span> <span class="n">evt</span>

    <span class="k">def</span> <span class="nf">__point_data_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="sd">&quot;&quot;&quot;Returns tuple of mime type &amp; data. Auto encodes unicode strings (to utf8) and</span>
<span class="sd">           dictionaries (to ubjson) depending on client setting.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mime</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__auto_encode_decode</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">data</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="c1"># check top level dictionary keys</span>
                    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">):</span>
                        <span class="k">return</span> <span class="s1">&#39;idx/1&#39;</span><span class="p">,</span> <span class="n">ubjdumpb</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># application/ubjson</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;At least one key in dict not real (unicode) string&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">):</span>
                    <span class="k">return</span> <span class="s1">&#39;idx/2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>  <span class="c1"># text/plain; charset=utf8</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot auto-encode data of type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No mime type specified and not bytes object (auto-encode disabled)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">valid_mimetype</span><span class="p">(</span><span class="n">mime</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">mime</span><span class="p">,</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mime specified but data not bytes object&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid mime type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mime</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__bytes_to_share_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempt to auto-decode data&quot;&quot;&quot;</span>
        <span class="n">rbytes</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_DATA</span><span class="p">]</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_MIME</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__auto_encode_decode</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rbytes</span><span class="p">,</span> <span class="n">mime</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">expand_idx_mimetype</span><span class="p">(</span><span class="n">mime</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mime</span> <span class="o">==</span> <span class="s1">&#39;application/ubjson&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ubjloadb</span><span class="p">(</span><span class="n">rbytes</span><span class="p">),</span> <span class="bp">None</span>
            <span class="k">elif</span> <span class="n">mime</span> <span class="o">==</span> <span class="s1">&#39;text/plain; charset=utf8&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rbytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rbytes</span><span class="p">,</span> <span class="n">mime</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;auto-decode failed, returning bytes&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">DEBUG_ENABLED</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rbytes</span><span class="p">,</span> <span class="n">mime</span>

    <span class="k">def</span> <span class="nf">request_point_share</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_share lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">mime_check_convert</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">datetime_check_convert</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">mime</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__point_data_to_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_FEED</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;share&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_sub_ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_ask sub_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">)</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">sub_id</span><span class="p">)</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">mime_check_convert</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">mime</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__point_data_to_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_id</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_sub_tell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_tell sub_id=</span><span class="si">%s</span><span class="s2"> timeout=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">sub_id</span><span class="p">)</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">mime_check_convert</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">mime</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__point_data_to_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_id</span><span class="p">,</span> <span class="s1">&#39;tell&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">timeout</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_sub_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_delete sub_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_DELETE</span><span class="p">,</span> <span class="p">(</span><span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">sub_id</span><span class="p">),),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_sub_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_list lid=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_sub_recent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_recent sub_id=</span><span class="si">%s</span><span class="s2">, count=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">sub_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_id</span><span class="p">,</span> <span class="s1">&#39;recent&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">request_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="n">SearchType</span><span class="o">.</span><span class="n">FULL</span><span class="p">,</span>
                       <span class="n">local</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">SearchScope</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_search text=</span><span class="si">%s</span><span class="s2"> lang=</span><span class="si">%s</span><span class="s2"> location=</span><span class="si">%s</span><span class="s2"> unit=</span><span class="si">%s</span><span class="s2"> limit=</span><span class="si">%s</span><span class="s2"> offset=</span><span class="si">%s</span><span class="s2"> type_=</span><span class="si">%s</span><span class="s2"> scope=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="n">text</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">local</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Use scope instead of local parameter&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="c1"># Preserve old behaviour until local parameter removed</span>
            <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="n">SearchScope</span><span class="o">.</span><span class="n">LOCAL</span>
        <span class="k">elif</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SearchScope</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;scope not one of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">SearchScope</span><span class="p">))</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">search_type_check_convert</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SEARCH</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">type_</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">scope</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                             <span class="n">Validation</span><span class="o">.</span><span class="n">search_check_convert</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span>
                                                             <span class="n">default_lang</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span><span class="p">),</span>
                             <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">DescribeScope</span><span class="o">.</span><span class="n">AUTO</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_describe guid=</span><span class="si">%s</span><span class="s2"> lang=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">local</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Use scope instead of local parameter&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="c1"># Preserve old behaviour until local parameter removed</span>
            <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="n">DescribeScope</span><span class="o">.</span><span class="n">LOCAL</span>
        <span class="k">elif</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DescribeScope</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;scope not one of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">DescribeScope</span><span class="p">))</span>
        <span class="n">guid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">guid</span><span class="p">)</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lang_check_convert</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_DESCRIBE</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">guid</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">scope</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__rnd_string</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_REQ_PREFIX_CHARS</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__new_request_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;requestId follows form &quot;pre num&quot; where pre is some random ascii prefix EG 6 chars long</span>
<span class="sd">        and num is an ever increasing number (self.__reqnum). MUST be called within self.__requests lock</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># Since seqnum wraps on 2^64 at most, this should always fit into 32 chars (QAPI request id limit)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum_lock</span><span class="p">:</span>
                <span class="n">requestId</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reqpre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reqnum</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__reqnum</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">requestId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># in the unlikely event of a collision update prefix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__reqpre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rnd_string</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">requestId</span>

    <span class="c1"># used by __make_hash</span>
    <span class="n">__byte_packer</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;&gt;Q&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__make_hash</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">innermsg</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">seqnum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the hash for this innermsg, token, seqnum</span>
<span class="sd">        return digest bytes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hobj</span> <span class="o">=</span> <span class="n">hmacNew</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">digestmod</span><span class="o">=</span><span class="n">hashfunc</span><span class="p">)</span>
        <span class="n">hobj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">innermsg</span><span class="p">)</span>
        <span class="n">hobj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__byte_packer</span><span class="p">(</span><span class="n">seqnum</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hobj</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__check_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return true/false if hash is good</span>
<span class="sd">        message = dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">[</span><span class="n">W_HASH</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_hash</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="n">W_MESSAGE</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__token</span><span class="p">,</span> <span class="n">message</span><span class="p">[</span><span class="n">W_SEQ</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__make_innermsg</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return innermsg chunk (dict)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;action must be None/tuple/list&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">{</span><span class="n">M_RESOURCE</span><span class="p">:</span> <span class="n">resource</span><span class="p">,</span>
             <span class="n">M_TYPE</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">rtype</span><span class="p">),</span>
             <span class="n">M_CLIENTREF</span><span class="p">:</span> <span class="n">ref</span><span class="p">,</span>
             <span class="c1"># Ensure action path consists only of strings</span>
             <span class="n">M_ACTION</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">u</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">action</span><span class="p">)</span> <span class="k">if</span> <span class="n">action</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
             <span class="n">M_PAYLOAD</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1"># Note: fmtted like &quot;0/15&quot; where 0 = offset, 15 = limit</span>
            <span class="n">p</span><span class="p">[</span><span class="n">M_RANGE</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">__request_except</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestId</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">set_and_forget</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set exception (if not None) for the given request and (optionally) remove from internal cache &amp; setting its</span>
<span class="sd">           event&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">set_and_forget</span><span class="p">:</span>
                    <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">requestId</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">[</span><span class="n">requestId</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unknown request </span><span class="si">%s</span><span class="s1"> - cannot set exception&#39;</span><span class="p">,</span> <span class="n">requestId</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">exc</span>
            <span class="k">if</span> <span class="n">set_and_forget</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__request_mark_sent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set send time &amp; clear exception from request if set, ignoring non-existent requests&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">[</span><span class="n">requestId</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># request might have had a response already have been removed by receiving thread</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">req</span><span class="o">.</span><span class="n">_send_time</span> <span class="o">=</span> <span class="n">monotonic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qmsg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True unless sending failed (at which point an exception will have been set in the request)&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum_lock</span><span class="p">:</span>
            <span class="n">seqnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">_SEQ_WRAP_SIZE</span>
        <span class="c1">#</span>
        <span class="n">innermsg</span> <span class="o">=</span> <span class="n">ubjdumpb</span><span class="p">(</span><span class="n">qmsg</span><span class="o">.</span><span class="n">inner_msg</span><span class="p">)</span>
        <span class="n">clevel</span> <span class="o">=</span> <span class="n">COMP_NONE</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">innermsg</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__comp_size</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Compressing payload&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">innermsg</span> <span class="o">=</span> <span class="n">COMPRESSORS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__comp_default</span><span class="p">]</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">innermsg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unknown compression method </span><span class="si">%s</span><span class="s1">, not compressing&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__comp_default</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__comp_default</span>

        <span class="n">p</span> <span class="o">=</span> <span class="p">{</span><span class="n">W_SEQ</span><span class="p">:</span> <span class="n">seqnum</span><span class="p">,</span>
             <span class="n">W_MESSAGE</span><span class="p">:</span> <span class="n">innermsg</span><span class="p">,</span>
             <span class="n">W_HASH</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_hash</span><span class="p">(</span><span class="n">innermsg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__token</span><span class="p">,</span> <span class="n">seqnum</span><span class="p">),</span>
             <span class="n">W_COMPRESSION</span><span class="p">:</span> <span class="n">clevel</span><span class="p">}</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">ubjdumpb</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># do not send messages exceeding size limit</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">VALIDATION_MAX_ENCODED_LENGTH</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__request_except</span><span class="p">(</span><span class="n">qmsg</span><span class="o">.</span><span class="n">requestId</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Message Payload too large </span><span class="si">%d</span><span class="s2"> &gt; </span><span class="si">%d</span><span class="s2">&quot;</span>
                                                             <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">VALIDATION_MAX_ENCODED_LENGTH</span><span class="p">)))</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/ubjson&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG_ENABLED</span><span class="p">:</span>
            <span class="n">p</span><span class="p">[</span><span class="n">W_MESSAGE</span><span class="p">]</span> <span class="o">=</span> <span class="n">qmsg</span><span class="o">.</span><span class="n">inner_msg</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">decode_sent_msg</span><span class="p">(</span><span class="s1">&#39;decode_sent_msg&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
        <span class="c1"># Callback any debuggers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_SEND</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="nd">@profiled_thread</span>  <span class="c1"># noqa (complexity)</span>
    <span class="k">def</span> <span class="nf">__network_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="n">queue_get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span><span class="o">.</span><span class="n">get</span>
        <span class="n">queue_task_done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span><span class="o">.</span><span class="n">task_done</span>
        <span class="n">retry_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_timeout</span>
        <span class="n">end_is_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">is_set</span>
        <span class="n">qmsg</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">end_is_set</span><span class="p">():</span>
            <span class="c1"># retrieve next message</span>
            <span class="k">if</span> <span class="n">qmsg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">qmsg</span> <span class="o">=</span> <span class="n">queue_get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">requestId</span> <span class="o">=</span> <span class="n">qmsg</span><span class="o">.</span><span class="n">requestId</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># wait before retrying previously failed request</span>
                <span class="k">if</span> <span class="n">retry_timeout</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">0.5</span><span class="p">):</span>
                        <span class="c1"># shutting down</span>
                        <span class="k">break</span>

            <span class="k">if</span> <span class="n">retry_timeout</span> <span class="ow">and</span> <span class="n">qmsg</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">retry_timeout</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;requestId &#39;</span><span class="si">%s</span><span class="s2">&#39; timeout after </span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">requestId</span><span class="p">,</span> <span class="n">retry_timeout</span><span class="p">)</span>
                <span class="c1"># note: previously set exception is preserved</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__request_except</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__send_throttle</span><span class="p">():</span>
                    <span class="c1"># end event (shutdown) set during throttling</span>
                    <span class="k">break</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">published</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__publish</span><span class="p">(</span><span class="n">qmsg</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">LinkException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to send &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">requestId</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">retry_timeout</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__request_except</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">set_and_forget</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                        <span class="c1"># request will be retried (assuming timeout is not reached after delay)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__request_except</span><span class="p">(</span><span class="n">requestId</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if not published, an exception will have been set on the request already</span>
                    <span class="k">if</span> <span class="n">published</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sent request &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">requestId</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__request_mark_sent</span><span class="p">(</span><span class="n">requestId</span><span class="p">)</span>

            <span class="n">queue_task_done</span><span class="p">()</span>
            <span class="n">qmsg</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__send_throttle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if end event was set during throttling-wait&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">throttler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_throttlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">throttler</span><span class="o">.</span><span class="n">throttle</span><span class="p">():</span>
                <span class="c1"># end event was set</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__fire_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if at least one callback was called&quot;&quot;&quot;</span>
        <span class="n">called</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">plain_submit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span><span class="o">.</span><span class="n">submit</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">:</span>
            <span class="n">submit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__crud_threadpool</span><span class="o">.</span><span class="n">submit</span> <span class="k">if</span> <span class="n">type_</span> <span class="ow">in</span> <span class="n">_CB_CRUD_TYPES</span> <span class="k">else</span> <span class="n">plain_submit</span>
            <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">[</span><span class="n">type_</span><span class="p">]:</span>
                <span class="n">called</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c1"># allow CRUD callbacks to not be serialised if requested</span>
                <span class="p">(</span><span class="n">submit</span> <span class="k">if</span> <span class="n">serialised_if_crud</span> <span class="k">else</span> <span class="n">plain_submit</span><span class="p">)(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">called</span>

    <span class="k">def</span> <span class="nf">__dispatch_ka</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Keep alive from container&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_KA</span><span class="p">)</span>

    <span class="n">__msg_wrapper_keys</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">W_SEQ</span><span class="p">,</span> <span class="n">W_COMPRESSION</span><span class="p">,</span> <span class="n">W_MESSAGE</span><span class="p">,</span> <span class="n">W_HASH</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__valid_msg_wrapper</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span>
                <span class="c1"># Python v2 doesn&#39;t support views, so cast to set</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="n">cls</span><span class="o">.</span><span class="n">__msg_wrapper_keys</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapper</span><span class="p">[</span><span class="n">W_SEQ</span><span class="p">],</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapper</span><span class="p">[</span><span class="n">W_MESSAGE</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapper</span><span class="p">[</span><span class="n">W_COMPRESSION</span><span class="p">],</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapper</span><span class="p">[</span><span class="n">W_HASH</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">))</span>

    <span class="n">__msg_body_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">OrderedDict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
    <span class="n">__msg_body_keys</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">M_CLIENTREF</span><span class="p">,</span> <span class="n">M_TYPE</span><span class="p">,</span> <span class="n">M_PAYLOAD</span><span class="p">))</span>
    <span class="n">__msg_body_payload_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">OrderedDict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>
    <span class="n">__msg_body_clientref_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">unicode_type</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__valid_msg_body</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__msg_body_types</span><span class="p">)</span> <span class="ow">and</span>
                <span class="c1"># Python v2 doesn&#39;t support views, so cast to set</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="n">cls</span><span class="o">.</span><span class="n">__msg_body_keys</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">],</span> <span class="n">cls</span><span class="o">.</span><span class="n">__msg_body_clientref_types</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">],</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">],</span> <span class="n">cls</span><span class="o">.</span><span class="n">__msg_body_payload_types</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__validate_decode_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>  <span class="c1"># noqa (complexity) pylint: disable=too-many-return-statements,too-many-branches</span>
        <span class="sd">&quot;&quot;&quot;Decodes wrapper, check hash &amp; seq, decodes body. Returns body or None, if validation / unpack failed&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_CONTENT_TYPE_PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content_type</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Message with unexpected content type </span><span class="si">%s</span><span class="s1"> from container, ignoring&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">content_type</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Message without content type from container, ignoring&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># Decode &amp; check message wrapper</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">ubjloadb</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed to decode message wrapper, ignoring&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">DEBUG_ENABLED</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_msg_wrapper</span><span class="p">(</span><span class="n">body</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid message wrapper, ignoring&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># currently only warn although maybe this should be an error</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cnt_seqnum</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_seqnum</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="n">W_SEQ</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cnt_seqnum</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unexpected seqnum from container: </span><span class="si">%d</span><span class="s1"> (last seen: </span><span class="si">%d</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">[</span><span class="n">W_SEQ</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">__cnt_seqnum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cnt_seqnum</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="n">W_SEQ</span><span class="p">]</span>

        <span class="c1"># Check message hash</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__check_hash</span><span class="p">(</span><span class="n">body</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Message has invalid hash, ignoring&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Decompress inner message</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">COMPRESSORS</span><span class="p">[</span><span class="n">body</span><span class="p">[</span><span class="n">W_COMPRESSION</span><span class="p">]]</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="n">W_MESSAGE</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Received message with unknown compression: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">[</span><span class="n">W_COMPRESSION</span><span class="p">])</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">OversizeException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Uncompressed message exceeds </span><span class="si">%d</span><span class="s1"> bytes, ignoring&#39;</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">DEBUG_ENABLED</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Decompression failed, ignoring message&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">DEBUG_ENABLED</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Decode inner message</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">ubjloadb</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed to decode message, ignoring&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">DEBUG_ENABLED</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_msg_body</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">body</span><span class="p">[</span><span class="n">W_SEQ</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Message with invalid body, ignoring: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__dispatch_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the signature and update RequestEvents / perform callbacks</span>

<span class="sd">        Note messages with an invalid wrapper, invalid hash, invalid sequence number or unexpected clientRef</span>
<span class="sd">        will be sent to debug_bad callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__validate_decode_msg</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">,</span> <span class="n">seqnum</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_BAD</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">content_type</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">DEBUG_ENABLED</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">decode_rcvd_msg</span><span class="p">(</span><span class="s1">&#39;decode_rcvd_msg&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">seqnum</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_RCVD</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="c1"># no reference, or set by client (not container)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_RSP_CONTAINER_REF</span><span class="p">:</span>
            <span class="c1"># solicitied</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__handle_known_solicited</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Ignoring response for unknown request </span><span class="si">%s</span><span class="s1"> of type </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">])</span>
            <span class="c1"># unsolicitied</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__perform_unsolicited_callbacks</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># unsolicited but can have reference set by container</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">E_CONTROLREQ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__handle_controlreq</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unhandled unsolicited message of type </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__handle_known_solicited</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns True if message has been handled as a solicited response&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__handle_low_seq_resend</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>

            <span class="n">perform_cb</span> <span class="o">=</span> <span class="n">finish</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_RSP_NO_REF</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__update_existing</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
                <span class="c1"># Finalise request if applicable (not marked as finished here so can perform callback first below)</span>
                <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_RSP_TYPE_FINISH</span><span class="p">:</span>
                    <span class="n">finish</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="c1"># Exception - DUPLICATED also should produce callback</span>
                    <span class="n">perform_cb</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">E_DUPLICATED</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_RSP_TYPE_ONGOING</span><span class="p">:</span>
                    <span class="n">perform_cb</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Reference unexpected for request </span><span class="si">%s</span><span class="s1"> of type </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">],</span>
                               <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">])</span>

        <span class="c1"># outside lock to avoid deadlock if callbacks try to perform request-related functions</span>
        <span class="k">if</span> <span class="n">perform_cb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__perform_unsolicited_callbacks</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># mark request as finished</span>
        <span class="k">if</span> <span class="n">finish</span><span class="p">:</span>
            <span class="n">req</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_RSP_TYPE_SUCCESS</span>
            <span class="n">req</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__clear_references</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="c1"># Serialise completion of CRUD requests (together with CREATED, DELETED, etc. messages)</span>
            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">is_crud</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__crud_threadpool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">_set</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">req</span><span class="o">.</span><span class="n">_set</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__clear_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">remove_request</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove any internal references to the given request&quot;&quot;&quot;</span>
        <span class="c1"># remove request itself</span>
        <span class="k">if</span> <span class="n">remove_request</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id_</span><span class="p">)</span>
        <span class="c1"># remove request type specific references</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id_</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id_</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__update_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Propagate changes based on type of message. MUST be called within self.__requests lock. Performs additional</span>
<span class="sd">           actions when solicited messages arrive.&quot;&quot;&quot;</span>
        <span class="n">req</span><span class="o">.</span><span class="n">_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_RSP_TYPE_CREATION</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_RESOURCE</span><span class="p">]</span> <span class="o">==</span> <span class="n">R_SUB</span><span class="p">:</span>
                <span class="c1"># Add callback for feeddata</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">:</span>
                        <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_POINT_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">R_FEED</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">[</span><span class="n">_CB_FEED</span><span class="p">][</span><span class="n">payload</span><span class="p">[</span><span class="n">P_POINT_ID</span><span class="p">]]</span> <span class="o">=</span> <span class="n">callback</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Subscription intended to feed is actually control: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_POINT_ID</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_RESOURCE</span><span class="p">]</span> <span class="o">==</span> <span class="n">R_CONTROL</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="p">:</span>
                        <span class="c1"># callbacks by thing</span>
                        <span class="n">entity_point_callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="p">[</span><span class="n">_CB_CONTROL</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="n">P_ENTITY_LID</span><span class="p">],</span> <span class="p">{})</span>
                        <span class="c1"># callback by thing and point</span>
                        <span class="n">entity_point_callbacks</span><span class="p">[</span><span class="n">payload</span><span class="p">[</span><span class="n">P_LID</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">E_RECENTDATA</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">[</span><span class="n">P_SAMPLES</span><span class="p">]:</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__decode_data_time</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
                <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_RECENT_DATA</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_CLIENTREF</span><span class="p">],</span>
                                                   <span class="s1">&#39;samples&#39;</span><span class="p">:</span> <span class="n">samples</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">__handle_low_seq_resend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;special error case - low sequence number (update sequence number &amp; resend if applicable). Returns True if</span>
<span class="sd">           a resend was scheduled, False otherwise. MUST be called within self.__requests lock.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">E_FAILED</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">][</span><span class="n">P_CODE</span><span class="p">]</span> <span class="o">==</span> <span class="n">E_FAILED_CODE_LOWSEQNUM</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum_lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">][</span><span class="n">P_MESSAGE</span><span class="p">])</span>
            <span class="c1"># return value indicating shutdown not useful here since this is run in receiver thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__retry_enqueue</span><span class="p">(</span><span class="n">PreparedMessage</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">_inner_msg_out</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">id_</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="n">__share_time_fmt</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">Z&#39;</span>

    <span class="k">def</span> <span class="nf">__decode_data_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract time and decode payload (based on mime type) from payload. Applies to E_FEEDDATA and E_RECENTDATA.</span>
<span class="sd">        Returns tuple of data, mime, time.&quot;&quot;&quot;</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">mime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bytes_to_share_data</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">P_TIME</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__share_time_fmt</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Share payload from container has invalid timestamp (</span><span class="si">%s</span><span class="s1">), will use naive local time&#39;</span><span class="p">,</span>
                           <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">P_TIME</span><span class="p">))</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">time</span>

    <span class="k">def</span> <span class="nf">__perform_unsolicited_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callbacks for which a client reference is either optional or does not apply at all&quot;&quot;&quot;</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_TYPE</span><span class="p">]</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">M_PAYLOAD</span><span class="p">]</span>

        <span class="c1"># callbacks for responses which might be unsolicited (e.g. created or deleted)</span>
        <span class="k">if</span> <span class="n">type_</span> <span class="ow">in</span> <span class="n">_RSP_PAYLOAD_CB_MAPPING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_RSP_PAYLOAD_CB_MAPPING</span><span class="p">[</span><span class="n">type_</span><span class="p">],</span> <span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Perform callbacks for feed data</span>
        <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="n">E_FEEDDATA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__simulate_feeddata</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="n">P_FEED_ID</span><span class="p">],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__decode_data_time</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>

        <span class="c1"># Perform callbacks for unsolicited subscriber message</span>
        <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="n">E_SUBSCRIBED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fire_callback</span><span class="p">(</span><span class="n">_CB_SUBSCRIPTION</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unexpected message type for unsolicited callback </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#IoticAgent.Core.Client.Client">Client</a></li>
          <li>builtins.object</li>
          </ul>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, host, vhost, epId, passwd, token, prefix=&#39;&#39;, lang=None, sslca=None, network_retry_timeout=300, socket_timeout=30, auto_encode_decode=True, send_queue_size=128, throttle_conf=&#39;&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p><code>host</code> amqp broker "host:port"</p>
<p><code>vhost</code> amqp broker virtual host</p>
<p><code>epId</code> amqp username</p>
<p><code>passwd</code> amqp broker password</p>
<p><code>token</code> ascii hex token secret</p>
<p><code>prefix</code> epId prefix depends on container settings</p>
<p><code>lang</code> language code to use for relevant (meta data) requests. If not set, the container
       container default will be used. See also default_lang.</p>
<p><code>sslca</code> path to file of broker SSL Certificate (IF NOT using Public)</p>
<p><code>network_retry_timeout</code> If 0 no retry/timeout else seconds.</p>
<p><code>socket_timeout</code> Underlying socket connection/operation timeout</p>
<p><code>auto_encode_decode</code> Automatically encode/decode text (utf8) and dictionaries (ubjson) when
                     sending/receiving point data. When sending, only applies if mime type not specified.</p>
<p><code>send_queue_size</code> Maximum number of unsent requets to keep in interval queue. The queue can reach
                  its size limit when using asynchronous requests AND either <code>throttle_conf</code> is
                  used or if the the client has not been connected to the container for a while
                  (due to network problems). Set to zero for no limit.</p>
<p><code>throttle_conf</code> Automatic request (outgoing) throttling, specified as comma-separate list of
                REQUESTS/INTERVAL pairs. E.g. '180/60,600/300' would result in no more than 180
                requests being sent over the last 60 seconds and no more than 600 requests over the
                last 5 minutes. Used to prevent rate-limiting containers from temporarily banning
                the client without requiring application code to introduce artificial delays.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.__init__', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.__init__" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">vhost</span><span class="p">,</span> <span class="n">epId</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>  <span class="c1"># pylint: disable=too-many-locals</span>
             <span class="n">sslca</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">network_retry_timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">socket_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">auto_encode_decode</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">send_queue_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
             <span class="n">throttle_conf</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    `host` amqp broker &quot;host:port&quot;</span>
<span class="sd">    `vhost` amqp broker virtual host</span>
<span class="sd">    `epId` amqp username</span>
<span class="sd">    `passwd` amqp broker password</span>
<span class="sd">    `token` ascii hex token secret</span>
<span class="sd">    `prefix` epId prefix depends on container settings</span>
<span class="sd">    `lang` language code to use for relevant (meta data) requests. If not set, the container</span>
<span class="sd">           container default will be used. See also default_lang.</span>
<span class="sd">    `sslca` path to file of broker SSL Certificate (IF NOT using Public)</span>
<span class="sd">    `network_retry_timeout` If 0 no retry/timeout else seconds.</span>
<span class="sd">    `socket_timeout` Underlying socket connection/operation timeout</span>
<span class="sd">    `auto_encode_decode` Automatically encode/decode text (utf8) and dictionaries (ubjson) when</span>
<span class="sd">                         sending/receiving point data. When sending, only applies if mime type not specified.</span>
<span class="sd">    `send_queue_size` Maximum number of unsent requets to keep in interval queue. The queue can reach</span>
<span class="sd">                      its size limit when using asynchronous requests AND either `throttle_conf` is</span>
<span class="sd">                      used or if the the client has not been connected to the container for a while</span>
<span class="sd">                      (due to network problems). Set to zero for no limit.</span>
<span class="sd">    `throttle_conf` Automatic request (outgoing) throttling, specified as comma-separate list of</span>
<span class="sd">                    REQUESTS/INTERVAL pairs. E.g. &#39;180/60,600/300&#39; would result in no more than 180</span>
<span class="sd">                    requests being sent over the last 60 seconds and no more than 600 requests over the</span>
<span class="sd">                    last 5 minutes. Used to prevent rate-limiting containers from temporarily banning</span>
<span class="sd">                    the client without requiring application code to introduce artificial delays.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ubjson version: </span><span class="si">%s</span><span class="s1"> (extension </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">ubj_version</span><span class="p">,</span> <span class="s1">&#39;enabled&#39;</span> <span class="k">if</span> <span class="n">ubj_ext</span> <span class="k">else</span> <span class="s1">&#39;disabled&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;__init__ config host=&#39;</span><span class="si">%s</span><span class="s2">&#39;, vhost=&#39;</span><span class="si">%s</span><span class="s2">&#39;, epId=&#39;</span><span class="si">%s</span><span class="s2">&#39;, passwd=&#39;</span><span class="si">%s</span><span class="s2">&#39;, token=&#39;</span><span class="si">%s</span><span class="s2">&#39;, prefix=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                 <span class="s2">&quot; , sslca=&#39;</span><span class="si">%s</span><span class="s2">&#39; network_retry_timeout=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                 <span class="n">host</span><span class="p">,</span> <span class="n">vhost</span><span class="p">,</span> <span class="n">epId</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">sslca</span><span class="p">,</span> <span class="n">network_retry_timeout</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">epId</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lang_check_convert</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__local_meta</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c1">#</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__token</span> <span class="o">=</span> <span class="n">a2b_hex</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
        <span class="n">raise_from</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;token invalid&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
    <span class="c1"># seq (from this client)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># request id numeric component</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__reqnum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;vhost&#39;</span><span class="p">,</span> <span class="s1">&#39;passwd&#39;</span><span class="p">):</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">check_convert_string</span><span class="p">(</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
    <span class="c1"># Only applies until ping response (see start() method)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_compression</span><span class="p">(</span><span class="n">comp</span><span class="o">=</span><span class="n">COMP_NONE</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__reqpre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rnd_string</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__auto_encode_decode</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">auto_encode_decode</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span> <span class="o">=</span> <span class="n">AmqpLink</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">vhost</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dispatch_msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dispatch_ka</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">__send_ready_cb</span><span class="p">,</span> <span class="n">sslca</span><span class="o">=</span><span class="n">sslca</span><span class="p">,</span>
                               <span class="n">socket_timeout</span><span class="o">=</span><span class="n">validate_nonnegative_int</span><span class="p">(</span><span class="n">socket_timeout</span><span class="p">,</span> <span class="s1">&#39;socket_timeout&#39;</span><span class="p">,</span>
                                                                       <span class="n">allow_zero</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
    <span class="c1"># seq (from container - initial value used to surpress warning on first message from container)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__cnt_seqnum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="c1"># (Core.Client has not been .start or is .stop)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__end</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="c1"># Timer used to retry sending of requests which might not have reached the broker (dummy instance set here)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
    <span class="c1"># network_retry thread</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_timeout</span> <span class="o">=</span> <span class="n">validate_nonnegative_int</span><span class="p">(</span><span class="n">network_retry_timeout</span><span class="p">,</span> <span class="s1">&#39;network_retry_timeout&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue_size</span> <span class="o">=</span> <span class="n">validate_nonnegative_int</span><span class="p">(</span><span class="n">send_queue_size</span><span class="p">,</span> <span class="s1">&#39;send_queue_size&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_throttlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_throttlers</span><span class="p">(</span><span class="n">throttle_conf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="p">)</span>
    <span class="c1"># __requests stores all incoming messages {&#39;requestId&#39;: event}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span> <span class="o">=</span> <span class="n">ThreadSafeDict</span><span class="p">()</span>
    <span class="c1">#</span>
    <span class="c1"># Remember pending subscriptions &amp; control callbacks.  __dispatch_msg will bind them when CREATED.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span> <span class="o">=</span> <span class="n">ThreadSafeDict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span> <span class="o">=</span> <span class="n">ThreadSafeDict</span><span class="p">()</span>
    <span class="c1">#</span>
    <span class="c1"># __callbacks stores (un)solicited message registered callbacks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span> <span class="o">=</span> <span class="n">ThreadSafeDict</span><span class="p">((</span><span class="n">type_</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">type_</span> <span class="ow">in</span>
                                      <span class="p">(</span><span class="n">_CB_DEBUG_KA</span><span class="p">,</span> <span class="n">_CB_DEBUG_SEND</span><span class="p">,</span> <span class="n">_CB_DEBUG_BAD</span><span class="p">,</span> <span class="n">_CB_DEBUG_RCVD</span><span class="p">,</span> <span class="n">_CB_CREATED</span><span class="p">,</span>
                                       <span class="n">_CB_DUPLICATE</span><span class="p">,</span> <span class="n">_CB_RENAMED</span><span class="p">,</span> <span class="n">_CB_DELETED</span><span class="p">,</span> <span class="n">_CB_FEEDDATA</span><span class="p">,</span> <span class="n">_CB_CONTROLREQ</span><span class="p">,</span>
                                       <span class="n">_CB_REASSIGNED</span><span class="p">,</span> <span class="n">_CB_SUBSCRIPTION</span><span class="p">,</span> <span class="n">_CB_RECENT_DATA</span><span class="p">))</span>
    <span class="c1"># mappings of pointId -&gt; callback list</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__callbacks</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">type_</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">type_</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_CB_FEED</span><span class="p">,</span> <span class="n">_CB_CONTROL</span><span class="p">)})</span>
    <span class="c1">#</span>
    <span class="c1"># Background thread for forwarding resource CRUD related events, including completion of CRUD requests</span>
    <span class="c1"># All such callbacks happen in a single thread so ordering of potentially related events is consistent.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__crud_threadpool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">daemonic</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Callback threadpool for any callbacks not covered by CRUD thread</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">daemonic</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Store container params from request_ping response</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__container_params</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.get_seqnum">
    <p>def <span class="ident">get_seqnum</span>(</p><p>self)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.get_seqnum', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.get_seqnum" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">get_seqnum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__seqnum</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.is_alive">
    <p>def <span class="ident">is_alive</span>(</p><p>self)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.is_alive', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.is_alive" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.register_callback_controlreq">
    <p>def <span class="ident">register_callback_controlreq</span>(</p><p>self, func)</p>
    </div>
    

    
  
    <div class="desc"><p>Register a callback function to every CONTROLREQ message! The callback receives a single
dict argument, with keys of 'data' (decoded or raw bytes), 'mime' (None, unless payload
was not decoded and has a mime type), 'subId' (the global id of the associated subscripion),
'entityLid' (local id of the thing to which the control belongs), 'lid' (local id of
control), 'confirm' (whether a confirmation is expected) and 'requestId' (required for
sending confirmation).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.register_callback_controlreq', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.register_callback_controlreq" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">register_callback_controlreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a callback function to every CONTROLREQ message! The callback receives a single</span>
<span class="sd">    dict argument, with keys of &#39;data&#39; (decoded or raw bytes), &#39;mime&#39; (None, unless payload</span>
<span class="sd">    was not decoded and has a mime type), &#39;subId&#39; (the global id of the associated subscripion),</span>
<span class="sd">    &#39;entityLid&#39; (local id of the thing to which the control belongs), &#39;lid&#39; (local id of</span>
<span class="sd">    control), &#39;confirm&#39; (whether a confirmation is expected) and &#39;requestId&#39; (required for</span>
<span class="sd">    sending confirmation).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_CONTROLREQ</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.register_callback_created">
    <p>def <span class="ident">register_callback_created</span>(</p><p>self, func, serialised=True)</p>
    </div>
    

    
  
    <div class="desc"><p>Register a callback function to receive QAPI Unsolicited (resource) CREATED. The
callback receives a single argument - the inner message. If <code>serialised</code> is not set,
the callbacks might arrive out-of-order (e.g. created point before created thing).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.register_callback_created', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.register_callback_created" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">register_callback_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (resource) CREATED. The</span>
<span class="sd">    callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">    the callbacks might arrive out-of-order (e.g. created point before created thing).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_CREATED</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.register_callback_debug_bad">
    <p>def <span class="ident">register_callback_debug_bad</span>(</p><p>self, func)</p>
    </div>
    

    
  
    <div class="desc"><p>Register a callback function to every BAD received message (EG bad sign). The callback
receives two arguments - the received message in raw byte form and the content type</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.register_callback_debug_bad', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.register_callback_debug_bad" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">register_callback_debug_bad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a callback function to every BAD received message (EG bad sign). The callback</span>
<span class="sd">    receives two arguments - the received message in raw byte form and the content type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_BAD</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.register_callback_debug_rcvd">
    <p>def <span class="ident">register_callback_debug_rcvd</span>(</p><p>self, func)</p>
    </div>
    

    
  
    <div class="desc"><p>Register a callback function to every GOOD recieved message. The callback receives a single
argument - the unwrapped message as a dict.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.register_callback_debug_rcvd', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.register_callback_debug_rcvd" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">register_callback_debug_rcvd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a callback function to every GOOD recieved message. The callback receives a single</span>
<span class="sd">    argument - the unwrapped message as a dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_RCVD</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.register_callback_debug_send">
    <p>def <span class="ident">register_callback_debug_send</span>(</p><p>self, func)</p>
    </div>
    

    
  
    <div class="desc"><p>Register a callback function for every sent message, including on retries. The callback
receives a single argument - the sent message in raw byte form.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.register_callback_debug_send', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.register_callback_debug_send" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">register_callback_debug_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a callback function for every sent message, including on retries. The callback</span>
<span class="sd">       receives a single argument - the sent message in raw byte form.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DEBUG_SEND</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.register_callback_deleted">
    <p>def <span class="ident">register_callback_deleted</span>(</p><p>self, func, serialised=True)</p>
    </div>
    

    
  
    <div class="desc"><p>Register a callback function to receive QAPI Unsolicited (resource) DELETED. The
callback receives a single argument - the inner message. If <code>serialised</code> is not set,
the callbacks might arrive out-of-order.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.register_callback_deleted', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.register_callback_deleted" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">register_callback_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (resource) DELETED. The</span>
<span class="sd">    callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">    the callbacks might arrive out-of-order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DELETED</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.register_callback_duplicate">
    <p>def <span class="ident">register_callback_duplicate</span>(</p><p>self, func, serialised=True)</p>
    </div>
    

    
  
    <div class="desc"><p>Register a callback function to receive QAPI Unsolicited (resource) DUPLICATE. The
callback receives a single argument - the inner message. If <code>serialised</code> is not set,
the callbacks might arrive out-of-order.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.register_callback_duplicate', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.register_callback_duplicate" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">register_callback_duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (resource) DUPLICATE. The</span>
<span class="sd">    callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">    the callbacks might arrive out-of-order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_DUPLICATE</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.register_callback_feeddata">
    <p>def <span class="ident">register_callback_feeddata</span>(</p><p>self, func)</p>
    </div>
    

    
  
    <div class="desc"><p>Register a callback function to every FEEDDATA message! The callback receives a single
dict argument, with keys of 'data' (decoded or raw bytes), 'mime' (None, unless payload
was not decoded and has a mime type) and 'pid' (the global id of the feed from which
the data originates).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.register_callback_feeddata', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.register_callback_feeddata" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">register_callback_feeddata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a callback function to every FEEDDATA message! The callback receives a single</span>
<span class="sd">    dict argument, with keys of &#39;data&#39; (decoded or raw bytes), &#39;mime&#39; (None, unless payload</span>
<span class="sd">    was not decoded and has a mime type) and &#39;pid&#39; (the global id of the feed from which</span>
<span class="sd">    the data originates).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_FEEDDATA</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.register_callback_reassigned">
    <p>def <span class="ident">register_callback_reassigned</span>(</p><p>self, func, serialised=True)</p>
    </div>
    

    
  
    <div class="desc"><p>Register a callback function to receive QAPI Unsolicited (entity) REASSIGNED. The
callback receives a single argument - the inner message. If <code>serialised</code> is not set,
the callbacks might arrive out-of-order.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.register_callback_reassigned', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.register_callback_reassigned" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">register_callback_reassigned</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (entity) REASSIGNED. The</span>
<span class="sd">    callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">    the callbacks might arrive out-of-order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_REASSIGNED</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.register_callback_recent_data">
    <p>def <span class="ident">register_callback_recent_data</span>(</p><p>self, func)</p>
    </div>
    

    
  
    <div class="desc"><p>Register a callback function to receive recent data samples. The callback receives
a single argument - a dict with c, the reference to the original request, pointId, the
id of the point to which the data applies, and samples, a list of dicts containing time
(the timestamp of the recent data sample), mime and data. If auto_encode_decode is enabled,
the data &amp; mime fields might be modified."</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.register_callback_recent_data', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.register_callback_recent_data" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">register_callback_recent_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a callback function to receive recent data samples. The callback receives</span>
<span class="sd">    a single argument - a dict with c, the reference to the original request, pointId, the</span>
<span class="sd">    id of the point to which the data applies, and samples, a list of dicts containing time</span>
<span class="sd">    (the timestamp of the recent data sample), mime and data. If auto_encode_decode is enabled,</span>
<span class="sd">    the data &amp; mime fields might be modified.&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_RECENT_DATA</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.register_callback_renamed">
    <p>def <span class="ident">register_callback_renamed</span>(</p><p>self, func, serialised=True)</p>
    </div>
    

    
  
    <div class="desc"><p>Register a callback function to receive QAPI Unsolicited (resource) RENAMED. The
callback receives a single argument - the inner message. If <code>serialised</code> is not set,
the callbacks might arrive out-of-order.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.register_callback_renamed', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.register_callback_renamed" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">register_callback_renamed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a callback function to receive QAPI Unsolicited (resource) RENAMED. The</span>
<span class="sd">    callback receives a single argument - the inner message. If `serialised` is not set,</span>
<span class="sd">    the callbacks might arrive out-of-order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_RENAMED</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">serialised_if_crud</span><span class="o">=</span><span class="n">serialised</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.register_callback_subscription">
    <p>def <span class="ident">register_callback_subscription</span>(</p><p>self, func)</p>
    </div>
    

    
  
    <div class="desc"><p>Register a callback function to receive subscription count changes. The callback receives
a single argument - a dict with r, the resource type (R_FEED or R_CONTROL), entityLid (the
nickname of the thing to which the point belongs), lid (the nickname of the point) and
subCount (the current subscription count). Note: Subscription count changes can occur for
each new (or deleted) subscription.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.register_callback_subscription', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.register_callback_subscription" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">register_callback_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a callback function to receive subscription count changes. The callback receives</span>
<span class="sd">    a single argument - a dict with r, the resource type (R_FEED or R_CONTROL), entityLid (the</span>
<span class="sd">    nickname of the thing to which the point belongs), lid (the nickname of the point) and</span>
<span class="sd">    subCount (the current subscription count). Note: Subscription count changes can occur for</span>
<span class="sd">    each new (or deleted) subscription.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__add_callback</span><span class="p">(</span><span class="n">_CB_SUBSCRIPTION</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_describe">
    <p>def <span class="ident">request_describe</span>(</p><p>self, guid, lang=None, local=None, scope=&lt;DescribeScope.AUTO: &#39;auto&#39;&gt;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_describe', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_describe" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">DescribeScope</span><span class="o">.</span><span class="n">AUTO</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_describe guid=</span><span class="si">%s</span><span class="s2"> lang=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">local</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Use scope instead of local parameter&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="c1"># Preserve old behaviour until local parameter removed</span>
        <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="n">DescribeScope</span><span class="o">.</span><span class="n">LOCAL</span>
    <span class="k">elif</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DescribeScope</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;scope not one of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">DescribeScope</span><span class="p">))</span>
    <span class="n">guid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">guid</span><span class="p">)</span>
    <span class="n">lang</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lang_check_convert</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_DESCRIBE</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">guid</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">scope</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_entity_create">
    <p>def <span class="ident">request_entity_create</span>(</p><p>self, lid, epId=None)</p>
    </div>
    

    
  
    <div class="desc"><p>request entity create: lid = local name to user
If epId=None (default), the current agent/EP is chosen
If epId=False, no agent is assigned
If epId=guid, said agent is chosen</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_entity_create', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_entity_create" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_entity_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">epId</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;request entity create: lid = local name to user</span>
<span class="sd">    If epId=None (default), the current agent/EP is chosen</span>
<span class="sd">    If epId=False, no agent is assigned</span>
<span class="sd">    If epId=guid, said agent is chosen</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">epId</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">epId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span>
    <span class="k">elif</span> <span class="n">epId</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">epId</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">epId</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">epId</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_create lid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;epId&#39;</span><span class="p">:</span> <span class="n">epId</span><span class="p">,</span> <span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">lid</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_entity_delete">
    <p>def <span class="ident">request_entity_delete</span>(</p><p>self, lid)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_entity_delete', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_entity_delete" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_entity_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">):</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_delete lid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_DELETE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_entity_list">
    <p>def <span class="ident">request_entity_list</span>(</p><p>self, limit=500, offset=0)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_entity_list', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_entity_list" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_entity_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_list&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__epId</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_entity_list_all">
    <p>def <span class="ident">request_entity_list_all</span>(</p><p>self, limit=500, offset=0)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_entity_list_all', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_entity_list_all" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_entity_list_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_list_all&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_entity_meta_get">
    <p>def <span class="ident">request_entity_meta_get</span>(</p><p>self, lid, fmt=&#39;n3&#39;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_entity_meta_get', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_entity_meta_get" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_entity_meta_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">):</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">metafmt_check_convert</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_meta_get lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; fmt=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_META</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_entity_meta_set">
    <p>def <span class="ident">request_entity_meta_set</span>(</p><p>self, lid, meta, fmt=&#39;n3&#39;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_entity_meta_set', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_entity_meta_set" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_entity_meta_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">):</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">metafmt_check_convert</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_meta_set lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; fmt=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_META</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="n">meta</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">fmt</span><span class="p">})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_entity_meta_setpublic">
    <p>def <span class="ident">request_entity_meta_setpublic</span>(</p><p>self, lid, public=True)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_entity_meta_setpublic', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_entity_meta_setpublic" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_entity_meta_setpublic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_meta_setpublic lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; public=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">public</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_META</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="s1">&#39;setPublic&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;public&#39;</span><span class="p">:</span> <span class="n">public</span><span class="p">})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_entity_reassign">
    <p>def <span class="ident">request_entity_reassign</span>(</p><p>self, lid, nepId=None)</p>
    </div>
    

    
  
    <div class="desc"><p>request entity to be reassigned to given ep/agent
If nepId=None (default), the current agent/EP is chosen
If nepId=False, no agent is assigned
If nepId=guid, said agent is chosen</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_entity_reassign', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_entity_reassign" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_entity_reassign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">nepId</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;request entity to be reassigned to given ep/agent</span>
<span class="sd">    If nepId=None (default), the current agent/EP is chosen</span>
<span class="sd">    If nepId=False, no agent is assigned</span>
<span class="sd">    If nepId=guid, said agent is chosen</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nepId</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">nepId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epId</span>
    <span class="k">elif</span> <span class="n">nepId</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">nepId</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nepId</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">nepId</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_reassign lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; -&gt; nepId=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">nepId</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="s1">&#39;reassign&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;epId&#39;</span><span class="p">:</span> <span class="n">nepId</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_entity_rename">
    <p>def <span class="ident">request_entity_rename</span>(</p><p>self, lid, newlid)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_entity_rename', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_entity_rename" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_entity_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">newlid</span><span class="p">):</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">newlid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">newlid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_rename lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; -&gt; newlid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">newlid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">newlid</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_entity_tag_list">
    <p>def <span class="ident">request_entity_tag_list</span>(</p><p>self, lid, limit=100, offset=0)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_entity_tag_list', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_entity_tag_list" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_entity_tag_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_tag_list lid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_TAG_META</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_entity_tag_update">
    <p>def <span class="ident">request_entity_tag_update</span>(</p><p>self, lid, tags, delete=False)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_entity_tag_update', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_entity_tag_update" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_entity_tag_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">tags_check_convert</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
    <span class="n">delete</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">bool_check_convert</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_entity_tag_update lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; tags=</span><span class="si">%s</span><span class="s2"> delete=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_ENTITY_TAG_META</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="n">delete</span><span class="p">})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_ping">
    <p>def <span class="ident">request_ping</span>(</p><p>self)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_ping', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_ping" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_ping&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_PING</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_confirm_tell">
    <p>def <span class="ident">request_point_confirm_tell</span>(</p><p>self, foc, lid, pid, success=True, requestId=None)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_confirm_tell', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_confirm_tell" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_confirm_tell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">requestId</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">success</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">bool_check_convert</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="n">success</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_confirm_tell foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; success=</span><span class="si">%s</span><span class="s2"> requestId=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span>
                 <span class="n">success</span><span class="p">,</span> <span class="n">requestId</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;confirm&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">success</span><span class="p">},</span> <span class="n">requestId</span><span class="o">=</span><span class="n">requestId</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_create">
    <p>def <span class="ident">request_point_create</span>(</p><p>self, foc, lid, pid, control_cb=None, save_recent=0)</p>
    </div>
    

    
  
    <div class="desc"><p>request point create: feed or control, lid and pid point lid</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_create', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_create" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">control_cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">save_recent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;request point create: feed or control, lid and pid point lid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">save_recent</span> <span class="o">=</span> <span class="n">validate_int</span><span class="p">(</span><span class="n">save_recent</span><span class="p">,</span> <span class="s1">&#39;save_recent&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_create foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; save_recent=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">save_recent</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">foc</span> <span class="o">==</span> <span class="n">R_CONTROL</span><span class="p">:</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">callable_check</span><span class="p">(</span><span class="n">control_cb</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_recent</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ignoring non-zero save_recent value for control&#39;</span><span class="p">)</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">pid</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pending_controls</span><span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_cb</span>
        <span class="k">return</span> <span class="n">evt</span>
    <span class="k">elif</span> <span class="n">control_cb</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;callback specified for Feed&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;saveRecent&#39;</span><span class="p">:</span> <span class="n">save_recent</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_delete">
    <p>def <span class="ident">request_point_delete</span>(</p><p>self, foc, lid, pid)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_delete', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_delete" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_delete foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_DELETE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_list">
    <p>def <span class="ident">request_point_list</span>(</p><p>self, foc, lid, limit=500, offset=0)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_list', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_list" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_list foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_list_detailed">
    <p>def <span class="ident">request_point_list_detailed</span>(</p><p>self, foc, lid, pid)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_list_detailed', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_list_detailed" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_list_detailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_list_detailed foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_meta_get">
    <p>def <span class="ident">request_point_meta_get</span>(</p><p>self, foc, lid, pid, fmt=&#39;n3&#39;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_meta_get', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_meta_get" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_meta_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">):</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">metafmt_check_convert</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
    <span class="n">foc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__res_to_meta</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_meta_get foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; fmt=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_meta_set">
    <p>def <span class="ident">request_point_meta_set</span>(</p><p>self, foc, lid, pid, meta, fmt=&#39;n3&#39;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_meta_set', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_meta_set" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_meta_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">):</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">metafmt_check_convert</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
    <span class="n">foc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__res_to_meta</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_meta_set foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; fmt=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="n">meta</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">fmt</span><span class="p">})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_recent_config">
    <p>def <span class="ident">request_point_recent_config</span>(</p><p>self, foc, lid, pid, max_samples=0)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_recent_config', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_recent_config" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_recent_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">max_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">max_samples</span> <span class="o">=</span> <span class="n">validate_int</span><span class="p">(</span><span class="n">max_samples</span><span class="p">,</span> <span class="s1">&#39;max_samples&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_recent_config foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;recent&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;maxSamples&#39;</span><span class="p">:</span> <span class="n">max_samples</span><span class="p">})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_recent_info">
    <p>def <span class="ident">request_point_recent_info</span>(</p><p>self, foc, lid, pid)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_recent_info', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_recent_info" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_recent_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_recent_info foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;recent&#39;</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_rename">
    <p>def <span class="ident">request_point_rename</span>(</p><p>self, foc, lid, pid, newpid)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_rename', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_rename" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">newpid</span><span class="p">):</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">newpid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">newpid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_rename foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; -&gt; newpid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">newpid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;lid&#39;</span><span class="p">:</span> <span class="n">newpid</span><span class="p">},</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_share">
    <p>def <span class="ident">request_point_share</span>(</p><p>self, lid, pid, data, mime=None, time=None)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_share', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_share" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_share</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_share lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">mime</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">mime_check_convert</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">datetime_check_convert</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">mime</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__point_data_to_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_FEED</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;share&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_tag_list">
    <p>def <span class="ident">request_point_tag_list</span>(</p><p>self, foc, lid, pid, limit=500, offset=0)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_tag_list', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_tag_list" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_tag_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_tag_list foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__point_type_to_tag_type</span><span class="p">(</span><span class="n">foc</span><span class="p">),</span>
                         <span class="n">C_LIST</span><span class="p">,</span>
                         <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span>
                         <span class="bp">None</span><span class="p">,</span>
                         <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_tag_update">
    <p>def <span class="ident">request_point_tag_update</span>(</p><p>self, foc, lid, pid, tags, delete=False)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_tag_update', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_tag_update" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_tag_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">tags_check_convert</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
    <span class="n">delete</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">bool_check_convert</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_tag_update foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; tags=</span><span class="si">%s</span><span class="s2"> delete=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__point_type_to_tag_type</span><span class="p">(</span><span class="n">foc</span><span class="p">),</span>
                         <span class="n">C_UPDATE</span><span class="p">,</span>
                         <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span>
                         <span class="p">{</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="n">delete</span><span class="p">})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_value_create">
    <p>def <span class="ident">request_point_value_create</span>(</p><p>self, lid, pid, foc, label, vtype, lang=None, comment=None, unit=None)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_value_create', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_value_create" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_value_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">value_type_check_convert</span><span class="p">(</span><span class="n">vtype</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">label_check_convert</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">lang</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lang_check_convert</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">comment_check_convert</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_value_create foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; label=</span><span class="si">%s</span><span class="s2"> vtype=</span><span class="si">%s</span><span class="s2"> lang=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span>
                 <span class="n">label</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_VALUE_META</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">),</span>
                         <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">vtype</span><span class="p">,</span> <span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="n">lang</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_value_delete">
    <p>def <span class="ident">request_point_value_delete</span>(</p><p>self, lid, pid, foc, label=None)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_value_delete', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_value_delete" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_value_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">label_check_convert</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_value_delete foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39; label=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_VALUE_META</span><span class="p">,</span> <span class="n">C_DELETE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">)</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_point_value_list">
    <p>def <span class="ident">request_point_value_list</span>(</p><p>self, lid, pid, foc, limit=500, offset=0)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_point_value_list', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_point_value_list" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_point_value_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_point_value_list foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_VALUE_META</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">),</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_search">
    <p>def <span class="ident">request_search</span>(</p><p>self, text=None, lang=None, location=None, unit=None, limit=100, offset=0, type_=&lt;SearchType.FULL: &#39;full&#39;&gt;, local=None, scope=&lt;SearchScope.PUBLIC: &#39;public&#39;&gt;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_search', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_search" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="n">SearchType</span><span class="o">.</span><span class="n">FULL</span><span class="p">,</span>
                   <span class="n">local</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">SearchScope</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_search text=</span><span class="si">%s</span><span class="s2"> lang=</span><span class="si">%s</span><span class="s2"> location=</span><span class="si">%s</span><span class="s2"> unit=</span><span class="si">%s</span><span class="s2"> limit=</span><span class="si">%s</span><span class="s2"> offset=</span><span class="si">%s</span><span class="s2"> type_=</span><span class="si">%s</span><span class="s2"> scope=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                 <span class="n">text</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">local</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Use scope instead of local parameter&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="c1"># Preserve old behaviour until local parameter removed</span>
        <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="n">SearchScope</span><span class="o">.</span><span class="n">LOCAL</span>
    <span class="k">elif</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SearchScope</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;scope not one of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">SearchScope</span><span class="p">))</span>
    <span class="n">type_</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">search_type_check_convert</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SEARCH</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">type_</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">scope</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                         <span class="n">Validation</span><span class="o">.</span><span class="n">search_check_convert</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span>
                                                         <span class="n">default_lang</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span><span class="p">),</span>
                         <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_sub_ask">
    <p>def <span class="ident">request_sub_ask</span>(</p><p>self, sub_id, data, mime=None)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_sub_ask', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_sub_ask" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_sub_ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_ask sub_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">)</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">sub_id</span><span class="p">)</span>
    <span class="n">mime</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">mime_check_convert</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">mime</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__point_data_to_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_id</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_sub_create">
    <p>def <span class="ident">request_sub_create</span>(</p><p>self, lid, foc, gpid, callback=None)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_sub_create', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_sub_create" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_sub_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">gpid</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">gpid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">foc</span> <span class="o">==</span> <span class="n">R_FEED</span><span class="p">:</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">callable_check</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Subscription for control cannot have callback&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_create foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; gpid=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">gpid</span><span class="p">)</span>
    <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">gpid</span><span class="p">),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span>
    <span class="k">return</span> <span class="n">evt</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_sub_create_local">
    <p>def <span class="ident">request_sub_create_local</span>(</p><p>self, slid, foc, lid, pid, callback=None)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_sub_create_local', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_sub_create_local" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_sub_create_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">slid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">slid</span><span class="p">)</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">foc_check</span><span class="p">(</span><span class="n">foc</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">pid_check_convert</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">foc</span> <span class="o">==</span> <span class="n">R_FEED</span><span class="p">:</span>
        <span class="n">Validation</span><span class="o">.</span><span class="n">callable_check</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Subscription for control cannot have callback&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_create_local slid=</span><span class="si">%s</span><span class="s2"> foc=</span><span class="si">%i</span><span class="s2"> lid=&#39;</span><span class="si">%s</span><span class="s2">&#39; pid=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">slid</span><span class="p">,</span> <span class="n">foc</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_CREATE</span><span class="p">,</span> <span class="p">(</span><span class="n">slid</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">foc</span><span class="p">),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pending_subs</span><span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span>
    <span class="k">return</span> <span class="n">evt</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_sub_delete">
    <p>def <span class="ident">request_sub_delete</span>(</p><p>self, sub_id)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_sub_delete', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_sub_delete" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_sub_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_delete sub_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_DELETE</span><span class="p">,</span> <span class="p">(</span><span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">sub_id</span><span class="p">),),</span> <span class="n">is_crud</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_sub_list">
    <p>def <span class="ident">request_sub_list</span>(</p><p>self, lid, limit=500, offset=0)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_sub_list', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_sub_list" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_sub_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_list lid=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">lid_check_convert</span><span class="p">(</span><span class="n">lid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">lid</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_sub_recent">
    <p>def <span class="ident">request_sub_recent</span>(</p><p>self, sub_id, count=None)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_sub_recent', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_sub_recent" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_sub_recent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_recent sub_id=</span><span class="si">%s</span><span class="s2">, count=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">sub_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_LIST</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_id</span><span class="p">,</span> <span class="s1">&#39;recent&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.request_sub_tell">
    <p>def <span class="ident">request_sub_tell</span>(</p><p>self, sub_id, data, timeout, mime=None)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.request_sub_tell', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.request_sub_tell" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">request_sub_tell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request_sub_tell sub_id=</span><span class="si">%s</span><span class="s2"> timeout=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">sub_id</span><span class="p">)</span>
    <span class="n">mime</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">mime_check_convert</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">mime</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__point_data_to_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">R_SUB</span><span class="p">,</span> <span class="n">C_UPDATE</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_id</span><span class="p">,</span> <span class="s1">&#39;tell&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;mime&#39;</span><span class="p">:</span> <span class="n">mime</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">timeout</span><span class="p">})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.restore_event">
    <p>def <span class="ident">restore_event</span>(</p><p>self, requestId)</p>
    </div>
    

    
  
    <div class="desc"><p>restore an event based on the requestId.</p>
<p>For example if the user app had to shutdown with pending requests.
The user can rebuild the Events they were waiting for based on the requestId(s).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.restore_event', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.restore_event" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">restore_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestId</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;restore an event based on the requestId.</span>
<span class="sd">    For example if the user app had to shutdown with pending requests.</span>
<span class="sd">    The user can rebuild the Events they were waiting for based on the requestId(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">requestId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">[</span><span class="n">requestId</span><span class="p">]</span> <span class="o">=</span> <span class="n">RequestEvent</span><span class="p">(</span><span class="n">requestId</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.set_compression">
    <p>def <span class="ident">set_compression</span>(</p><p>self, comp=1, size=768)</p>
    </div>
    

    
  
    <div class="desc"><p>Override compression method (defined by container) and threshold</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.set_compression', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.set_compression" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">set_compression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="n">COMP_DEFAULT</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">COMP_SIZE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Override compression method (defined by container) and threshold&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">comp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">COMPRESSORS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">comp</span> <span class="o">==</span> <span class="n">COMP_LZ4F</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;lz4f compression not available, required lz4framed&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid compression method&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;size must be non-negative integer&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__comp_default</span> <span class="o">=</span> <span class="n">comp</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__comp_size</span> <span class="o">=</span> <span class="n">size</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__comp_default</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__comp_size</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.simulate_feeddata">
    <p>def <span class="ident">simulate_feeddata</span>(</p><p>self, feedid, data, mime=None, time=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Send feed data</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.simulate_feeddata', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.simulate_feeddata" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">simulate_feeddata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Send feed data&quot;&quot;&quot;</span>
    <span class="c1"># Separate public method since internal one does not require parameter checks</span>
    <span class="n">feedid</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">guid_check_convert</span><span class="p">(</span><span class="n">feedid</span><span class="p">)</span>
    <span class="n">mime</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="n">mime_check_convert</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">Validation</span><span class="o">.</span><span class="n">datetime_check_convert</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">to_iso8601</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__simulate_feeddata</span><span class="p">(</span><span class="n">feedid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">time</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.start">
    <p>def <span class="ident">start</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Start the send &amp; recv Threads.
Start can be delayed to EG restore requestIds before attaching to the QAPI
Note: This function waits for/blocks until amqplink connect(s) and the current
      sequence number has been obtained from the container (within 5 seconds)</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.start', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.start" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa (complexity)</span>
    <span class="sd">&quot;&quot;&quot;Start the send &amp; recv Threads.</span>
<span class="sd">    Start can be delayed to EG restore requestIds before attaching to the QAPI</span>
<span class="sd">    Note: This function waits for/blocks until amqplink connect(s) and the current</span>
<span class="sd">          sequence number has been obtained from the container (within 5 seconds)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__network_retry</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;network&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="n">raise_from</span><span class="p">(</span><span class="n">LinkException</span><span class="p">(</span><span class="s2">&quot;Core.AmqpLink: Failed to connect&quot;</span><span class="p">),</span> <span class="n">exc</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Unhandled startup error&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_ping</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">LinkException</span><span class="p">(</span><span class="s2">&quot;No container response to ping within 5s&quot;</span><span class="p">)</span>
        <span class="c1"># (for req.payload) pylint: disable=unsubscriptable-object</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">req</span><span class="o">.</span><span class="n">payload</span><span class="p">[</span><span class="n">P_MESSAGE</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unexpected ping failure: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">info</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">payload</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__qapi_version_check</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__default_lang</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__container_params</span> <span class="o">=</span> <span class="n">payload</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_compression</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">raise_from</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Container compression method (</span><span class="si">%d</span><span class="s1">) unsupported&#39;</span> <span class="o">%</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">]),</span> <span class="n">ex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__local_meta</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;local_meta&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__crud_threadpool</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">raise</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="IoticAgent.Core.Client.Client.stop">
    <p>def <span class="ident">stop</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Stop the Client, disconnect from queue</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-IoticAgent.Core.Client.Client.stop', this);">Show source &equiv;</a></p>
  <div id="source-IoticAgent.Core.Client.Client.stop" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stop the Client, disconnect from queue</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__end</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__send_retry_requests_timer</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__threadpool</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__crud_threadpool</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__amqplink</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="c1"># Clear out remaining pending requests</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
        <span class="n">shutdown</span> <span class="o">=</span> <span class="n">LinkShutdownException</span><span class="p">(</span><span class="s1">&#39;Client stopped&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">req</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">shutdown</span>
            <span class="n">req</span><span class="o">.</span><span class="n">_set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__clear_references</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">remove_request</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> unfinished request(s) discarded&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__requests</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="c1">#</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_thread</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__network_retry_queue</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__container_params</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>

  </div>
</div>

  </div>
  
          <h3>Instance variables</h3>
            <div class="item">
            <p id="IoticAgent.Core.Client.Client.container_params" class="name">var <span class="ident">container_params</span></p>
            

            
  
    <div class="desc"><p>Returns container configuration parameters as a mapping. Will be empty before start() has been called</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="IoticAgent.Core.Client.Client.default_lang" class="name">var <span class="ident">default_lang</span></p>
            

            
  
    <div class="desc"><p>Language in use when not explicitly specified (in meta related requests). Will be set to container default
if was not set in constructor. Before calling start() this might be None.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="IoticAgent.Core.Client.Client.epId" class="name">var <span class="ident">epId</span></p>
            

            
  
    <div class="desc"><p>EP/Agent id in use for this client</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="IoticAgent.Core.Client.Client.local_meta" class="name">var <span class="ident">local_meta</span></p>
            

            
  
    <div class="desc"><p>Whether container-local metadata functionality (e.g. search) is available in this container. Before calling
start() this will always be False.</p></div>
  <div class="source_cont">
</div>

            </div>
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
